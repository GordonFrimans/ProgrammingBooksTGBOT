//-go.sum-
github.com/cenkalti/backoff/v4 v4.3.0 h1:MyRJ/UdXutAwSAT+s3wNd7MfTIcy71VQueUuFK343L8=
github.com/cenkalti/backoff/v4 v4.3.0/go.mod h1:Y3VNntkOUPxTVeUxJ/G5vcM//AlwfmyYozVcomhLiZE=
github.com/coder/websocket v1.8.14 h1:9L0p0iKiNOibykf283eHkKUHHrpG7f65OE3BhhO7v9g=
github.com/coder/websocket v1.8.14/go.mod h1:NX3SzP+inril6yawo5CQXx8+fk145lPDC6pumgx0mVg=
github.com/davecgh/go-spew v1.1.0/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/davecgh/go-spew v1.1.1 h1:vj9j/u1bqnvCEfJOwUhtlOARqs3+rkHYY13jYWTU97c=
github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=
github.com/dlclark/regexp2 v1.11.5 h1:Q/sSnsKerHeCkc/jSTNq1oCm7KiVgUMZRDUoRu0JQZQ=
github.com/dlclark/regexp2 v1.11.5/go.mod h1:DHkYz0B9wPfa6wondMfaivmHpzrQ3v9q8cnmRbL6yW8=
github.com/dustin/go-humanize v1.0.1 h1:GzkhY7T5VNhEkwH0PVJgjz+fX1rhBrR7pRT3mDkpeCY=
github.com/dustin/go-humanize v1.0.1/go.mod h1:Mu1zIs6XwVuF/gI1OepvI0qD18qycQx+mFykh5fBlto=
github.com/fatih/color v1.18.0 h1:S8gINlzdQ840/4pfAwic/ZE0djQEH3wM94VfqLTZcOM=
github.com/fatih/color v1.18.0/go.mod h1:4FelSpRwEGDpQ12mAdzqdOukCy4u8WUtOY6lkT/6HfU=
github.com/ghodss/yaml v1.0.0 h1:wQHKEahhL6wmXdzwWG11gIVCkOv05bNOh+Rxn0yngAk=
github.com/ghodss/yaml v1.0.0/go.mod h1:4dBDuWmgqj2HViK6kFavaiC9ZROes6MMH2rRYeMEF04=
github.com/go-faster/errors v0.7.1 h1:MkJTnDoEdi9pDabt1dpWf7AA8/BaSYZqibYyhZ20AYg=
github.com/go-faster/errors v0.7.1/go.mod h1:5ySTjWFiphBs07IKuiL69nxdfd5+fzh1u7FPGZP2quo=
github.com/go-faster/jx v1.1.0 h1:ZsW3wD+snOdmTDy9eIVgQdjUpXRRV4rqW8NS3t+20bg=
github.com/go-faster/jx v1.1.0/go.mod h1:vKDNikrKoyUmpzaJ0OkIkRQClNHFX/nF3dnTJZb3skg=
github.com/go-faster/xor v0.3.0/go.mod h1:x5CaDY9UKErKzqfRfFZdfu+OSTfoZny3w5Ak7UxcipQ=
github.com/go-faster/xor v1.0.0 h1:2o8vTOgErSGHP3/7XwA5ib1FTtUsNtwCoLLBjl31X38=
github.com/go-faster/xor v1.0.0/go.mod h1:x5CaDY9UKErKzqfRfFZdfu+OSTfoZny3w5Ak7UxcipQ=
github.com/go-faster/yaml v0.4.6 h1:lOK/EhI04gCpPgPhgt0bChS6bvw7G3WwI8xxVe0sw9I=
github.com/go-faster/yaml v0.4.6/go.mod h1:390dRIvV4zbnO7qC9FGo6YYutc+wyyUSHBgbXL52eXk=
github.com/go-logr/logr v1.4.3 h1:CjnDlHq8ikf6E492q6eKboGOC0T8CDaOvkHCIg8idEI=
github.com/go-logr/logr v1.4.3/go.mod h1:9T104GzyrTigFIr8wt5mBrctHMim0Nb2HLGrmQ40KvY=
github.com/go-logr/stdr v1.2.2 h1:hSWxHoqTgW2S2qGc0LTAI563KZ5YKYRhT3MFKZMbjag=
github.com/go-logr/stdr v1.2.2/go.mod h1:mMo/vtBO5dYbehREoey6XUKy/eSumjCCveDpRre4VKE=
github.com/google/go-cmp v0.7.0 h1:wk8382ETsv4JYUZwIsn6YpYiWiBsYLSJiTsyBybVuN8=
github.com/google/go-cmp v0.7.0/go.mod h1:pXiqmnSA92OHEEa9HXL2W4E7lf9JzCmGVUdgjX3N/iU=
github.com/google/uuid v1.6.0 h1:NIvaJDMOsjHA8n1jAhLSgzrAzy1Hgr+hNrb57e+94F0=
github.com/google/uuid v1.6.0/go.mod h1:TIyPZe4MgqvfeYDBFedMoGGpEw/LqOeaOT+nhxU+yHo=
github.com/gotd/ige v0.2.2 h1:XQ9dJZwBfDnOGSTxKXBGP4gMud3Qku2ekScRjDWWfEk=
github.com/gotd/ige v0.2.2/go.mod h1:tuCRb+Y5Y3eNTo3ypIfNpQ4MFjrnONiL2jN2AKZXmb0=
github.com/gotd/neo v0.1.5 h1:oj0iQfMbGClP8xI59x7fE/uHoTJD7NZH9oV1WNuPukQ=
github.com/gotd/neo v0.1.5/go.mod h1:9A2a4bn9zL6FADufBdt7tZt+WMhvZoc5gWXihOPoiBQ=
github.com/gotd/td v0.132.0 h1:Iqm3S2b+8kDgA9237IDXRxj7sryUpvy+4Cr50/0tpx4=
github.com/gotd/td v0.132.0/go.mod h1:4CDGYS+rDtOqotRheGaF9MS5g6jaUewvSXqBNJnx8SQ=
github.com/jackc/pgpassfile v1.0.0 h1:/6Hmqy13Ss2zCq62VdNG8tM1wchn8zjSGOBJ6icpsIM=
github.com/jackc/pgpassfile v1.0.0/go.mod h1:CEx0iS5ambNFdcRtxPj5JhEz+xB6uRky5eyVu/W2HEg=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 h1:iCEnooe7UlwOQYpKFhBabPMi4aNAfoODPEFNiAnClxo=
github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761/go.mod h1:5TJZWKEWniPve33vlWYSoGYefn3gLQRzjfDlhSJ9ZKM=
github.com/jackc/pgx/v5 v5.7.6 h1:rWQc5FwZSPX58r1OQmkuaNicxdmExaEz5A2DO2hUuTk=
github.com/jackc/pgx/v5 v5.7.6/go.mod h1:aruU7o91Tc2q2cFp5h4uP3f6ztExVpyVv88Xl/8Vl8M=
github.com/jackc/puddle/v2 v2.2.2 h1:PR8nw+E/1w0GLuRFSmiioY6UooMp6KJv0/61nB7icHo=
github.com/jackc/puddle/v2 v2.2.2/go.mod h1:vriiEXHvEE654aYKXXjOvZM39qJ0q+azkZFrfEOc3H4=
github.com/klauspost/compress v1.18.0 h1:c/Cqfb0r+Yi+JtIEq73FWXVkRonBlf0CRNYc8Zttxdo=
github.com/klauspost/compress v1.18.0/go.mod h1:2Pp+KzxcywXVXMr50+X0Q/Lsb43OQHYWRCY2AiWywWQ=
github.com/kr/pretty v0.3.0 h1:WgNl7dwNpEZ6jJ9k1snq4pZsg7DOEN8hP9Xw0Tsjwk0=
github.com/kr/pretty v0.3.0/go.mod h1:640gp4NfQd8pI5XOwp5fnNeVWj67G7CFk/SaSQn7NBk=
github.com/kr/text v0.2.0 h1:5Nx0Ya0ZqY2ygV366QzturHI13Jq95ApcVaJBhpS+AY=
github.com/kr/text v0.2.0/go.mod h1:eLer722TekiGuMkidMxC/pM04lWEeraHUUmBw8l2grE=
github.com/mattn/go-colorable v0.1.14 h1:9A9LHSqF/7dyVVX6g0U9cwm9pG3kP9gSzcuIPHPsaIE=
github.com/mattn/go-colorable v0.1.14/go.mod h1:6LmQG8QLFO4G5z1gPvYEzlUgJ2wF+stgPZH1UqBm1s8=
github.com/mattn/go-isatty v0.0.20 h1:xfD0iDuEKnDkl03q4limB+vH+GxLEtL/jb4xVJSWWEY=
github.com/mattn/go-isatty v0.0.20/go.mod h1:W+V8PltTTMOvKvAeJH7IuucS94S2C6jfK/D7dTCTo3Y=
github.com/ogen-go/ogen v1.15.2 h1:Hy5XNcDgWur758Kf0+DTQFN8cyBOs58EjDD3NMqih54=
github.com/ogen-go/ogen v1.15.2/go.mod h1:bS+BP2cV7+IGjOM24znBmh+PrpZvYFXA7o3BNF4Hj2E=
github.com/pmezard/go-difflib v1.0.0 h1:4DBwDE0NGyQoBHbLQYPwSUPoCMWR5BEzIk/f1lZbAQM=
github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=
github.com/rogpeppe/go-internal v1.14.1 h1:UQB4HGPB6osV0SQTLymcB4TgvyWu6ZyliaW0tI/otEQ=
github.com/rogpeppe/go-internal v1.14.1/go.mod h1:MaRKkUm5W0goXpeCfT7UZI6fk/L7L7so1lCWt35ZSgc=
github.com/segmentio/asm v1.2.0 h1:9BQrFxC+YOHJlTlHGkTrFWf59nbL3XnCoFLTwDCI7ys=
github.com/segmentio/asm v1.2.0/go.mod h1:BqMnlJP91P8d+4ibuonYZw9mfnzI9HfxselHZr5aAcs=
github.com/stretchr/objx v0.1.0/go.mod h1:HFkY916IF+rwdDfMAkV7OtwuqBVzrE8GR6GFx+wExME=
github.com/stretchr/testify v1.3.0/go.mod h1:M5WIy9Dh21IEIfnGCwXGc5bZfKNJtfHm1UVUgZn+9EI=
github.com/stretchr/testify v1.7.0/go.mod h1:6Fq8oRcR53rry900zMqJjRRixrwX3KX962/h/Wwjteg=
github.com/stretchr/testify v1.11.1 h1:7s2iGBzp5EwR7/aIZr8ao5+dra3wiQyKjjFuvgVKu7U=
github.com/stretchr/testify v1.11.1/go.mod h1:wZwfW3scLgRK+23gO65QZefKpKQRnfz6sD981Nm4B6U=
go.opentelemetry.io/auto/sdk v1.1.0 h1:cH53jehLUN6UFLY71z+NDOiNJqDdPRaXzTel0sJySYA=
go.opentelemetry.io/auto/sdk v1.1.0/go.mod h1:3wSPjt5PWp2RhlCcmmOial7AvC4DQqZb7a7wCow3W8A=
go.opentelemetry.io/otel v1.38.0 h1:RkfdswUDRimDg0m2Az18RKOsnI8UDzppJAtj01/Ymk8=
go.opentelemetry.io/otel v1.38.0/go.mod h1:zcmtmQ1+YmQM9wrNsTGV/q/uyusom3P8RxwExxkZhjM=
go.opentelemetry.io/otel/metric v1.38.0 h1:Kl6lzIYGAh5M159u9NgiRkmoMKjvbsKtYRwgfrA6WpA=
go.opentelemetry.io/otel/metric v1.38.0/go.mod h1:kB5n/QoRM8YwmUahxvI3bO34eVtQf2i4utNVLr9gEmI=
go.opentelemetry.io/otel/trace v1.38.0 h1:Fxk5bKrDZJUH+AMyyIXGcFAPah0oRcT+LuNtJrmcNLE=
go.opentelemetry.io/otel/trace v1.38.0/go.mod h1:j1P9ivuFsTceSWe1oY+EeW3sc+Pp42sO++GHkg4wwhs=
go.uber.org/atomic v1.11.0 h1:ZvwS0R+56ePWxUNi+Atn9dWONBPp/AUETXlHW0DxSjE=
go.uber.org/atomic v1.11.0/go.mod h1:LUxbIzbOniOlMKjJjyPfpl4v+PKK2cNJn91OQbhoJI0=
go.uber.org/goleak v1.3.0 h1:2K3zAYmnTNqV73imy9J1T3WC+gmCePx2hEGkimedGto=
go.uber.org/goleak v1.3.0/go.mod h1:CoHD4mav9JJNrW/WLlf7HGZPjdw8EucARQHekz1X6bE=
go.uber.org/multierr v1.11.0 h1:blXXJkSxSSfBVBlC76pxqeO+LN3aDfLQo+309xJstO0=
go.uber.org/multierr v1.11.0/go.mod h1:20+QtiLqy0Nd6FdQB9TLXag12DsQkrbs3htMFfDN80Y=
go.uber.org/zap v1.27.0 h1:aJMhYGrd5QSmlpLMr2MftRKl7t8J8PTZPA732ud/XR8=
go.uber.org/zap v1.27.0/go.mod h1:GB2qFLM7cTU87MWRP2mPIjqfIDnGu+VIO4V/SdhGo2E=
golang.org/x/crypto v0.43.0 h1:dduJYIi3A3KOfdGOHX8AVZ/jGiyPa3IbBozJ5kNuE04=
golang.org/x/crypto v0.43.0/go.mod h1:BFbav4mRNlXJL4wNeejLpWxB7wMbc79PdRGhWKncxR0=
golang.org/x/exp v0.0.0-20230725093048-515e97ebf090 h1:Di6/M8l0O2lCLc6VVRWhgCiApHV8MnQurBnFSHsQtNY=
golang.org/x/exp v0.0.0-20230725093048-515e97ebf090/go.mod h1:FXUEEKJgO7OQYeo8N01OfiKP8RXMtf6e8aTskBGqWdc=
golang.org/x/mod v0.29.0 h1:HV8lRxZC4l2cr3Zq1LvtOsi/ThTgWnUk/y64QSs8GwA=
golang.org/x/mod v0.29.0/go.mod h1:NyhrlYXJ2H4eJiRy/WDBO6HMqZQ6q9nk4JzS3NuCK+w=
golang.org/x/net v0.46.0 h1:giFlY12I07fugqwPuWJi68oOnpfqFnJIJzaIIm2JVV4=
golang.org/x/net v0.46.0/go.mod h1:Q9BGdFy1y4nkUwiLvT5qtyhAnEHgnQ/zd8PfU6nc210=
golang.org/x/sync v0.0.0-20201207232520-09787c993a3a/go.mod h1:RxMgew5VJxzue5/jJTE5uejpjVlOe/izrB70Jof72aM=
golang.org/x/sync v0.17.0 h1:l60nONMj9l5drqw6jlhIELNv9I0A4OFgRsG9k2oT9Ug=
golang.org/x/sync v0.17.0/go.mod h1:9KTHXmSnoGruLpwFjVSX0lNNA75CykiMECbovNTZqGI=
golang.org/x/sys v0.6.0/go.mod h1:oPkhp1MJrh7nUepCBck5+mAzfO9JrbApNNgaTdGDITg=
golang.org/x/sys v0.37.0 h1:fdNQudmxPjkdUTPnLn5mdQv7Zwvbvpaxqs831goi9kQ=
golang.org/x/sys v0.37.0/go.mod h1:OgkHotnGiDImocRcuBABYBEXf8A9a87e/uXjp9XT3ks=
golang.org/x/text v0.30.0 h1:yznKA/E9zq54KzlzBEAWn1NXSQ8DIp/NYMy88xJjl4k=
golang.org/x/text v0.30.0/go.mod h1:yDdHFIX9t+tORqspjENWgzaCVXgk0yYnYuSZ8UzzBVM=
golang.org/x/tools v0.38.0 h1:Hx2Xv8hISq8Lm16jvBZ2VQf+RLmbd7wVUsALibYI/IQ=
golang.org/x/tools v0.38.0/go.mod h1:yEsQ/d/YK8cjh0L6rZlY8tgtlKiBNTL14pGDJPJpYQs=
gopkg.in/check.v1 v0.0.0-20161208181325-20d25e280405/go.mod h1:Co6ibVJAznAaIkqp8huTwlJQCZ016jof/cbN4VW5Yz0=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c h1:Hei/4ADfdWqJk1ZMxUNpqntNwaWcugrBjAiHlqqRiVk=
gopkg.in/check.v1 v1.0.0-20201130134442-10cb98267c6c/go.mod h1:JHkPIbrfpd72SG/EVd6muEfDQjcINNoR0C8j2r3qZ4Q=
gopkg.in/yaml.v2 v2.4.0 h1:D8xgwECY7CYvx+Y2n4sBz93Jn9JRvxdiyyo8CTfuKaY=
gopkg.in/yaml.v2 v2.4.0/go.mod h1:RDklbk79AGWmwhnvt/jBztapEOGDOx6ZbXqjP6csGnQ=
gopkg.in/yaml.v3 v3.0.0-20200313102051-9f266ea9e77c/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
gopkg.in/yaml.v3 v3.0.1 h1:fxVm/GzAzEWqLHuvctI91KS9hhNmmWOoWu0XTYJS7CA=
gopkg.in/yaml.v3 v3.0.1/go.mod h1:K4uyk7z7BCEPqu6E+C64Yfv1cQ7kz7rIZviUmN+EgEM=
nhooyr.io/websocket v1.8.17 h1:KEVeLJkUywCKVsnLIDlD/5gtayKp8VoCkksHCGGfT9Y=
nhooyr.io/websocket v1.8.17/go.mod h1:rN9OFWIUwuxg4fR5tELlYC04bXYowCP9GX47ivo2l+c=
rsc.io/qr v0.2.0 h1:6vBLea5/NRMVTz8V66gipeLycZMl/+UlFmk8DvqQ6WY=
rsc.io/qr v0.2.0/go.mod h1:IF+uZjkb9fqyeF/4tlBoynqmQxUoPfWEKh921coOuXs=


//-bookInfo/core.go-
package bookinfo

import (
	"encoding/json"
	"fmt"
	"io"
	"net/http"
	"net/url"
	"os"
	"path/filepath"
	"strings"
	"time"

	"HIGH_PR/gl"
	"HIGH_PR/internal/logger"
)

type Result struct {
	Title       string
	Authors     []string
	Description string
	TextSnippet string
	Lang        string
	Img         string
}

type MinimalResponse struct {
	Items []struct {
		VolumeInfo struct {
			Title       string   `json:"title"`
			Authors     []string `json:"authors"`
			Description string   `json:"description"`
			Language    string   `json:"language"`
			ImageLinks  struct {
				Thumbnail      string `json:"thumbnail"`
				SmallThumbnail string `json:"smallThumbnail"`
			} `json:"imageLinks"`
		} `json:"volumeInfo"`
		SearchInfo struct {
			TextSnippet string `json:"textSnippet"`
		} `json:"searchInfo"`
	} `json:"items"`
}

func SearchBooks(name string) (Result, error) {
	name = strings.ReplaceAll(name, "_", " ")
	query := fmt.Sprintf("intitle:\"%s\" ru subject:\"computers\"", name)

	params := url.Values{}
	params.Add("q", query)
	params.Add("maxResults", "1")

	apiURL := fmt.Sprintf("https://www.googleapis.com/books/v1/volumes?%s", params.Encode())
	logger.Logger.Println("ü§ñü§ñü§ñ URL –∑–∞–ø—Ä–æ—Å–∞ –∫ –∫–Ω–∏–≥–µ:", apiURL)

	// Retry –ª–æ–≥–∏–∫–∞: 3 –ø–æ–ø—ã—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 5 —Å–µ–∫—É–Ω–¥
	const maxRetries = 3
	const retryDelay = 5 * time.Second

	var resp *http.Response
	var err error

	for attempt := 1; attempt <= maxRetries; attempt++ {
		resp, err = http.Get(apiURL)

		// –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—Ä–æ—à—ë–ª —É—Å–ø–µ—à–Ω–æ
		if err == nil {
			// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–¥
			if resp.StatusCode == http.StatusOK {
				// –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç - –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
				break
			}

			// –ï—Å–ª–∏ 503 - –ø—Ä–æ–±—É–µ–º —Ä–µ—Ç—Ä–∞–π
			if resp.StatusCode == http.StatusServiceUnavailable {
				body, _ := io.ReadAll(resp.Body)
				resp.Body.Close()

				logger.Logger.Printf("–ü–æ–ø—ã—Ç–∫–∞ %d/%d: Google API –≤–µ—Ä–Ω—É–ª 503: %s",
					attempt, maxRetries, string(body))

				// –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ - –¥–µ–ª–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É
				if attempt < maxRetries {
					logger.Logger.Printf("–û–∂–∏–¥–∞–Ω–∏–µ %v –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π...", retryDelay)
					time.Sleep(retryDelay)
					continue
				}

				// –ü–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å
				return Result{}, fmt.Errorf("Google API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ—Å–ª–µ %d –ø–æ–ø—ã—Ç–æ–∫: —Å—Ç–∞—Ç—É—Å 503", maxRetries)
			}

			// –î—Ä—É–≥–∏–µ –æ—à–∏–±–∫–∏ HTTP (–Ω–µ 503) - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–∑—É
			body, _ := io.ReadAll(resp.Body)
			resp.Body.Close()
			logger.Logger.Printf("Google API –≤–µ—Ä–Ω—É–ª —Å—Ç–∞—Ç—É—Å %d: %s", resp.StatusCode, string(body))
			return Result{}, fmt.Errorf("Google API –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É: —Å—Ç–∞—Ç—É—Å %d", resp.StatusCode)
		}

		// –û—à–∏–±–∫–∞ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
		logger.Logger.Printf("–ü–æ–ø—ã—Ç–∫–∞ %d/%d: –æ—à–∏–±–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–∞: %v", attempt, maxRetries, err)

		if attempt < maxRetries {
			logger.Logger.Printf("–û–∂–∏–¥–∞–Ω–∏–µ %v –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π...", retryDelay)
			time.Sleep(retryDelay)
			continue
		}

		return Result{}, fmt.Errorf("–æ—à–∏–±–∫–∞ HTTP –∑–∞–ø—Ä–æ—Å–∞ –ø–æ—Å–ª–µ %d –ø–æ–ø—ã—Ç–æ–∫: %w", maxRetries, err)
	}

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –≤–∞–ª–∏–¥–Ω—ã–π –æ—Ç–≤–µ—Ç
	if resp == nil || resp.StatusCode != http.StatusOK {
		return Result{}, fmt.Errorf("–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ %d –ø–æ–ø—ã—Ç–æ–∫", maxRetries)
	}

	defer resp.Body.Close()

	var minResp MinimalResponse
	if err := json.NewDecoder(resp.Body).Decode(&minResp); err != nil {
		return Result{}, fmt.Errorf("–æ—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON: %w", err)
	}

	if len(minResp.Items) == 0 {
		return Result{}, fmt.Errorf("–∫–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")
	}

	item := minResp.Items[0]

	result := Result{
		Title:       item.VolumeInfo.Title,
		Authors:     item.VolumeInfo.Authors,
		Description: item.VolumeInfo.Description,
		TextSnippet: item.SearchInfo.TextSnippet,
		Lang:        item.VolumeInfo.Language,
	}

	// –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
	imgURL := item.VolumeInfo.ImageLinks.Thumbnail
	if imgURL == "" {
		imgURL = item.VolumeInfo.ImageLinks.SmallThumbnail
	}
	result.Img = imgURL

	return result, nil
}

// DefaultSaveBook - –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π + /img
func DownloadImage(imgURL string) (string, error) {
	imgURL = strings.Replace(imgURL, "zoom=1", "zoom=0", 1)
	// –®–∞–≥ 1: –°–∫–∞—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
	resp, err := http.Get(imgURL)
	if err != nil {
		return "", fmt.Errorf("–æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: %w", err)
	}
	defer resp.Body.Close()

	// –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞
	if resp.StatusCode != http.StatusOK {
		return "", fmt.Errorf("—Å—Ç–∞—Ç—É—Å %d –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è", resp.StatusCode)
	}

	// –®–∞–≥ 4: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ (–∏—Å–ø–æ–ª—å–∑—É–µ–º timestamp)
	filename := fmt.Sprintf("image_%d.jpg", time.Now().UnixNano())
	filePath := filepath.Join(gl.DefaultSaveImage, filename)

	// –®–∞–≥ 5: –°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª –¥–ª—è –∑–∞–ø–∏—Å–∏
	file, err := os.Create(filePath)
	if err != nil {
		return "", fmt.Errorf("–æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞: %w", err)
	}
	defer file.Close()

	// –®–∞–≥ 6: –ö–æ–ø–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ –≤ —Ñ–∞–π–ª
	_, err = io.Copy(file, resp.Body)
	if err != nil {
		return "", fmt.Errorf("–æ—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ —Ñ–∞–π–ª–∞: %w", err)
	}

	// –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–º—É —Ñ–∞–π–ª—É
	return filePath, nil
}


//-bookInfo/tags.go-
package bookinfo

// CommonLanguages ‚Äî –∫–∞—Ä—Ç–∞ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —è–∑—ã–∫–æ–≤ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è.
// –ö–ª—é—á: –∞–ª–∏–∞—Å (–≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ), –ó–Ω–∞—á–µ–Ω–∏–µ: –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–æ–µ –∏–º—è —è–∑—ã–∫–∞.
var CommonLanguages = map[string]string{
	// Backend / Systems
	"go":     "Go",
	"golang": "Go",
	"rs":     "Rust",
	"rust":   "Rust",
	"java":   "Java",
	"jvm":    "Java",
	"kt":     "Kotlin",
	"kotlin": "Kotlin",
	"scala":  "Scala",
	"c":      "C",
	"cpp":    "C++",
	"c++":    "C++",
	"cs":     "C#",
	"csharp": "C#",
	"C#":     "C#",
	"net":    ".NET",
	"dotnet": ".NET",
	"elixir": "Elixir",
	"erlang": "Erlang",

	// Scripting / Web
	"py":         "Python",
	"python":     "Python",
	"rb":         "Ruby",
	"ruby":       "Ruby",
	"php":        "PHP",
	"js":         "JavaScript",
	"javascript": "JavaScript",
	"ts":         "TypeScript",
	"perl":       "Perl",
	"lua":        "Lua",
	"bash":       "Bash",
	"sh":         "Bash",
	"shell":      "Bash",

	// Mobile
	"swift": "Swift",
	"dart":  "Dart",
	"obj-c": "Objective-C",

	// Data
	"sql": "SQL",
	"r":   "R",
}

// TopicTags ‚Äî –∫–∞—Ä—Ç–∞ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (—Ä–æ–ª–∏/—Å—Ñ–µ—Ä—ã) –ø–æ –∫–ª—é—á–µ–≤–æ–º—É —Å–ª–æ–≤—É.
// –°—é–¥–∞ –≤—Ö–æ–¥—è—Ç —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –ø–æ–Ω—è—Ç–∏—è.
// –ö–ª—é—á: –∞–ª–∏–∞—Å, –ó–Ω–∞—á–µ–Ω–∏–µ: –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π –¢—ç–≥ (Role/Category).
var TopicTags = map[string]string{
	// Frontend
	"html":    "Frontend",
	"css":     "Frontend",
	"scss":    "Frontend",
	"vue":     "Frontend",
	"react":   "Frontend",
	"angular": "Frontend",
	"webpack": "Frontend",
	"jquery":  "Frontend",
	"wasm":    "Frontend",

	// Backend
	"spring":        "Backend",
	"django":        "Backend",
	"flask":         "Backend",
	"fastapi":       "Backend",
	"laravel":       "Backend",
	"symfony":       "Backend",
	"rails":         "Backend",
	"node":          "Backend",
	"nodejs":        "Backend",
	"microservices": "Backend",
	"api":           "Backend",
	"grpc":          "Backend",

	// Mobile
	"ios":          "Mobile",
	"android":      "Mobile",
	"flutter":      "Mobile",
	"react-native": "Mobile",
	"swiftui":      "Mobile",

	// DevOps / Cloud
	"docker":     "DevOps",
	"k8s":        "DevOps",
	"kubernetes": "DevOps",
	"terraform":  "DevOps",
	"ansible":    "DevOps",
	"jenkins":    "DevOps",
	"gitlab":     "DevOps",
	"aws":        "DevOps",
	"linux":      "DevOps",
	"nginx":      "DevOps",
	"ci/cd":      "DevOps",

	// Data / ML
	"mongo":      "Data",
	"redis":      "Data",
	"postgres":   "Data",
	"mysql":      "Data",
	"kafka":      "Data",
	"pandas":     "Data Science",
	"numpy":      "Data Science",
	"tensorflow": "Machine Learning",
	"pytorch":    "Machine Learning",
	"ml":         "Machine Learning",
	"ai":         "AI",

	// Architecture / CS
	"algo":          "Computer Science",
	"algorithms":    "Computer Science",
	"patterns":      "Architecture",
	"architecture":  "Architecture",
	"system-design": "Architecture",
	"distributed":   "Architecture",
	"clean-code":    "Best Practices",
	"refactoring":   "Best Practices",
	"tdd":           "Testing",
	"testing":       "Testing",

	// Security
	"security": "Security",
	"hacking":  "Security",
	"pentest":  "Security",
	"crypto":   "Security",
}

// LanguageDefaultCategories ‚Äî –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞.
// –ï—Å–ª–∏ –º—ã –Ω–∞—à–ª–∏ –Ø–∑—ã–∫, –Ω–æ –Ω–µ –Ω–∞—à–ª–∏ –¢—ç–≥, –º—ã –º–æ–∂–µ–º –ø—Ä–∏—Å–≤–æ–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –¢—ç–≥.
var LanguageDefaultCategories = map[string]string{
	"Go":         "Backend",
	"Java":       "Backend",
	"Kotlin":     "Mobile", // –∏–ª–∏ Backend, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –Ω–æ —á–∞—â–µ —Å–µ–π—á–∞—Å Mobile
	"C#":         "Backend",
	"JavaScript": "Frontend",
	"TypeScript": "Frontend",
	"Python":     "Backend", // –∏–ª–∏ Data Science, —Ç—É—Ç 50/50
	"PHP":        "Backend",
	"Swift":      "Mobile",
	"Dart":       "Mobile",
	"Rust":       "Backend",
	"C++":        "System",
	"C":          "System",
	"SQL":        "Data",
}


//-bookInfo/parseTags.go-
package bookinfo

import (
	"errors"
	"strings"
	"unicode"
)

// ParseMetadataFromTitle –ø–∞—Ä—Å–∏—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –ø—ã—Ç–∞–µ—Ç—Å—è –∏–∑–≤–ª–µ—á—å –Ø–∑—ã–∫ –∏ –ö–∞—Ç–µ–≥–æ—Ä–∏—é.
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: (language, tag, error)
func ParseMetadataFromInfo(title, description string) (string, string, error) {
	titleLower := strings.ToLower(title)
	descriptionLower := strings.ToLower(description)
	var foundLang string
	var foundTag string

	// 1. –ò—â–µ–º –Ø–∑—ã–∫ –ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è (–ø—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞—Ä—Ç–µ CommonLanguages –∏–∑ tags.go)
	for alias, langName := range CommonLanguages {
		if containsWholeWord(titleLower, alias) && foundLang == "" {
			foundLang = langName
			break // –ù–∞—à–ª–∏ —è–∑—ã–∫ - –≤—ã—Ö–æ–¥–∏–º. (–ú–æ–∂–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å, –µ—Å–ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ 2 —è–∑—ã–∫–∞)
		}
	}

	// 2. –ò—â–µ–º –¢—ç–≥/–¢–µ–º–∞—Ç–∏–∫—É (–ø—Ä–æ—Ö–æ–¥–∏–º –ø–æ –∫–∞—Ä—Ç–µ TopicTags –∏–∑ tags.go)
	for alias, tagName := range TopicTags {
		if containsWholeWord(titleLower, alias) && foundTag == "" {
			foundTag = tagName
			break
		}
	}
	//=============================
	//===–î–∞–ª–µ–µ –ø–æ–∏—Å–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é===
	//=============================
	for alias, tagName := range TopicTags {
		if containsWholeWord(descriptionLower, alias) && foundTag == "" {
			foundTag = tagName
			break
		}
	}

	for alias, langName := range CommonLanguages {
		if containsWholeWord(descriptionLower, alias) && foundLang == "" {
			foundLang = langName
			break // –ù–∞—à–ª–∏ —è–∑—ã–∫ - –≤—ã—Ö–æ–¥–∏–º. (–ú–æ–∂–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å, –µ—Å–ª–∏ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ 2 —è–∑—ã–∫–∞)
		}
	}
	//===========================

	// 3. –õ–æ–≥–∏–∫–∞ "–£–º–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è"
	// –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —è–∑—ã–∫, –Ω–æ –Ω–µ –Ω–∞—à–ª–∏ —Ç—ç–≥ ‚Äî –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π –¥–ª—è —ç—Ç–æ–≥–æ —è–∑—ã–∫–∞.
	// –ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∞—à–ª–∏ "Go", –Ω–æ –Ω–µ—Ç —Ç—ç–≥–æ–≤ —Ç–∏–ø–∞ "Microservices". –°—Ç–∞–≤–∏–º "Backend".
	if foundLang != "" && foundTag == "" {
		if defaultTag, ok := LanguageDefaultCategories[foundLang]; ok {
			foundTag = defaultTag
		}
	}

	// –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞—à–ª–∏
	if foundLang == "" && foundTag == "" {
		return "", "", errors.New("—Ç—ç–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
	}

	return foundLang, foundTag, nil
}

// containsWholeWord –∏—â–µ—Ç word –≤ text, —É—á–∏—Ç—ã–≤–∞—è –≥—Ä–∞–Ω–∏—Ü—ã —Å–ª–æ–≤.
// (–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–ª–∞—Å—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –æ–Ω–∞ –æ—Ç–ª–∏—á–Ω–∞—è)
func containsWholeWord(text, word string) bool {
	startPos := 0
	for {
		// –ò—â–µ–º –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –ø–æ–¥—Å—Ç—Ä–æ–∫–∏
		idx := strings.Index(text[startPos:], word)
		if idx == -1 {
			return false
		}

		// –í—ã—á–∏—Å–ª—è–µ–º —Ä–µ–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –∏ –∫–æ–Ω–µ—Ü —Å–ª–æ–≤–∞
		realIdx := startPos + idx
		endIdx := realIdx + len(word)

		// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–º–≤–æ–ª –°–õ–ï–í–ê
		isLeftBoundary := realIdx == 0 || !isWordChar(rune(text[realIdx-1]))

		// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–∏–º–≤–æ–ª –°–ü–†–ê–í–ê
		isRightBoundary := endIdx == len(text) || !isWordChar(rune(text[endIdx]))

		// –ï—Å–ª–∏ —Å –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω –≥—Ä–∞–Ω–∏—Ü—ã ‚Äî —ç—Ç–æ —Ü–µ–ª–æ–µ —Å–ª–æ–≤–æ!
		if isLeftBoundary && isRightBoundary {
			return true
		}

		// –ï—Å–ª–∏ –Ω–∞—à–ª–∏ —á–∞—Å—Ç—å —Å–ª–æ–≤–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä "c" –≤–Ω—É—Ç—Ä–∏ "Apache"), –∏—â–µ–º –¥–∞–ª—å—à–µ
		startPos = realIdx + 1
	}
}

// isWordChar –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, –µ—Å–ª–∏ —Å–∏–º–≤–æ–ª ‚Äî –±—É–∫–≤–∞ –∏–ª–∏ —Ü–∏—Ñ—Ä–∞
func isWordChar(r rune) bool {
	return unicode.IsLetter(r) || unicode.IsDigit(r)
}


//-gl/glData.go-
package gl

import (
	"bufio"
	"fmt"
	"os"
	"strings"
)

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑ –¥—Ä—É–≥–∏—Ö –ø–∞–∫–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ gl.AppID)
var (
	// main.go
	AppID       string
	AppHash     string
	PostgreURL  string
	SessionPath string

	// bot.go
	BotToken string

	// core.go
	DefaultSaveImage string

	// handelrs.go
	AdminID string
	LogPath string

	// fileOperation.go
	DefaultSaveBook string
)

func init() {
	// 1. –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ .env
	// –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ —Ç–µ–∫—É—â–µ–π –ø–∞–ø–∫–µ, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ
	if err := loadEnv(".env"); err != nil {
		// –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ —Ç–µ–∫—É—â–µ–π, –ø—Ä–æ–±—É–µ–º –≤ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∑–∞–ø—É—Å–∫–∞ –∏–∑ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø–∞–ø–æ–∫)
		if err2 := loadEnv("../.env"); err2 != nil {
			fmt.Printf("‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: —Ñ–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω (%v). –ù–∞–¥–µ–µ–º—Å—è, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω—ã –≤ —Å–∏—Å—Ç–µ–º–µ.\n", err)
			// –ù–µ –¥–µ–ª–∞–µ–º os.Exit(11), —á—Ç–æ–±—ã –∫–æ–¥ –º–æ–≥ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ Docker, –≥–¥–µ —Ñ–∞–π–ª–∞ .env –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–∏
		}
	}

	// 2. –í–ê–ñ–ù–û! –ü—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –ø–∞–∫–µ—Ç–∞ –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
	// –ï—Å–ª–∏ —ç—Ç–æ–≥–æ –Ω–µ —Å–¥–µ–ª–∞—Ç—å, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ gl.AppID –æ—Å—Ç–∞–Ω—É—Ç—Å—è –ø—É—Å—Ç—ã–º–∏ ""
	AppID = os.Getenv("appID")
	AppHash = os.Getenv("appHash")
	PostgreURL = os.Getenv("postgreURL")
	SessionPath = os.Getenv("sessionPath")

	BotToken = os.Getenv("botToken")
	DefaultSaveImage = os.Getenv("defaultSaveImage")
	AdminID = os.Getenv("adminID")
	LogPath = os.Getenv("logPath")
	DefaultSaveBook = os.Getenv("defaultSaveBook")

	// –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–¥–µ—Å—å
	if AppID == "" {
		fmt.Println("‚ùå –û—à–∏–±–∫–∞: AppID –Ω–µ –∑–∞–¥–∞–Ω!")
		os.Exit(1)
	}
}

func loadEnv(filename string) error {
	file, err := os.Open(filename)
	if err != nil {
		return err
	}
	defer file.Close()

	scanner := bufio.NewScanner(file)
	for scanner.Scan() {
		line := strings.TrimSpace(scanner.Text())
		if line == "" || strings.HasPrefix(line, "#") {
			continue
		}
		parts := strings.SplitN(line, "=", 2)
		if len(parts) != 2 {
			continue
		}
		key := strings.TrimSpace(parts[0])
		value := strings.TrimSpace(parts[1])
		value = strings.Trim(value, "\"'")

		os.Setenv(key, value)
	}
	return scanner.Err()
}


//-internal/middleware/middleware.go-
package middleware

import (
	"context"
	"fmt"
	"log"
	"time"

	"github.com/gotd/td/bin"
	"github.com/gotd/td/telegram"
	"github.com/gotd/td/tg"
)

// LoggingMiddleware –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ RPC-–≤—ã–∑–æ–≤—ã –∫ Telegram API
func LoggingMiddleware(logger *log.Logger) telegram.Middleware {
	return telegram.MiddlewareFunc(func(next tg.Invoker) telegram.InvokeFunc {
		return func(ctx context.Context, input bin.Encoder, output bin.Decoder) error {
			start := time.Now()

			// –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–æ–¥–∞
			methodName := extractMethodName(input)

			logger.Printf("‚Üí –í—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞: %s", methodName)

			// –í—ã–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤ —Ü–µ–ø–æ—á–∫–µ
			err := next.Invoke(ctx, input, output)

			duration := time.Since(start)

			if err != nil {
				logger.Printf("‚ùå –ú–µ—Ç–æ–¥ %s –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π –∑–∞ %v: %v",
					methodName, duration, err)
			} else {
				logger.Printf("‚úÖ –ú–µ—Ç–æ–¥ %s –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ –∑–∞ %v",
					methodName, duration)
			}

			return err
		}
	})
}

// extractMethodName –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∏–º—è –º–µ—Ç–æ–¥–∞ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞
func extractMethodName(input bin.Encoder) string {
	// –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º TypeName (–±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º–æ–µ –∏–º—è)
	if typed, ok := input.(interface{ TypeName() string }); ok {
		return typed.TypeName()
	}

	// –ï—Å–ª–∏ TypeName –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º TypeID
	if typed, ok := input.(interface{ TypeID() uint32 }); ok {
		return fmt.Sprintf("0x%x", typed.TypeID())
	}

	return "unknown"
}


//-internal/services/bookService.go-
package services

import (
	booktags "HIGH_PR/internal/repository/postgres/bookTags"
	"context"
)

// BookService —Å–æ–¥–µ—Ä–∂–∏—Ç –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–Ω–∏–≥–∞–º–∏
type BookService struct {
	repo *booktags.BookRepository
}

// NewBookService —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å
func NewBookService(repo *booktags.BookRepository) *BookService {
	return &BookService{repo: repo}
}

// GetAllBooks –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –∫–Ω–∏–≥–∏
func (s *BookService) GetAllBooks(ctx context.Context) ([]booktags.BookWithTags, error) {
	// –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
	// –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Ç.–¥.
	return s.repo.GetAllBooks(ctx)
}

func (s *BookService) AddBook(ctx context.Context, bt booktags.BookWithTags) error {
	// –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥–∏ ( –ü–û–ó–ñ–ï :) )

	return s.repo.AddBook(ctx, bt)
}

func (s *BookService) BookWithID(ctx context.Context, id int) (booktags.BookWithTags, error) {
	//WARNING
	return s.repo.BookWithID(ctx, id)
}

func (s *BookService) GetFileBookWithID(ctx context.Context, id int) (string, error) {
	return s.repo.GetFileBookWithID(ctx, id)
}

func (s *BookService) AddDownloadCountWithID(ctx context.Context, id int) error {
	return s.repo.AddDownloadCountWithID(ctx, id)
}

func (s *BookService) ShowBooksWithTag(ctx context.Context, tag string) ([]booktags.BookWithTags, error) {
	return s.repo.ShowBooksWithTag(ctx, tag)
}

func (s *BookService) SearchBooksWithTitleDesc(ctx context.Context, query string) ([]booktags.BookWithTags, error) {
	return s.repo.SearchBooksWithTitleDesc(ctx, query)
}


//-internal/repository/postgres/daily/dailyStat.go-
package daily

import (
	"HIGH_PR/internal/logger"
	"context"

	"github.com/jackc/pgx/v5/pgxpool"
)

// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ö—Ä–∞–Ω—è—â–∏–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –¥–µ–Ω—å!
func CreateTableStat(ctx context.Context, pool *pgxpool.Pool) error {
	logger.Logger.Println("–°–æ–∑–¥–∞–Ω–µ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
	createTableQuery := `
	CREATE TABLE IF NOT EXISTS daily_stats (

		date DATE PRIMARY KEY -- –î–∞—Ç–∞

		unique_users_count INT DEFAULT 0 --–ö–æ–ª-–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ—Å–µ—Ç–∏–≤—à–∏—Ö –±–æ—Ç–∞ –∑–∞ —É–∫–∞–∑ –¥–∞—Ç—É

		message_count INT DEFAULT 0 --–ö–æ–ª-–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π

		)


		-- –ò–Ω–¥–µ–∫—Å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–∞—Ç–µ (–¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤/–æ—Ç—á–µ—Ç–æ–≤)
		CREATE INDEX IF NOT EXISTS idx_daily_stats_date ON daily_stats(date DESC);
	`
	_, err := pool.Exec(ctx, createTableQuery)
	if err != nil {
		logger.Logger.Println("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã:", err)
		return err
	}

	logger.Logger.Println("–¢–∞–±–ª–∏—Ü—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã/–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã")
	return nil

}


//-internal/repository/postgres/coreDB.go-
package postgres

import (
	"context"
	"fmt"
	"time"

	"HIGH_PR/internal/logger"
	booktags "HIGH_PR/internal/repository/postgres/bookTags"

	"github.com/jackc/pgx/v5/pgxpool"
)

// InitDB —Å–æ–∑–¥–∞—ë—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç connection pool
func InitDB(databaseURL string) (*pgxpool.Pool, error) {
	ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
	defer cancel()

	// –ü–∞—Ä—Å–∏–º –∫–æ–Ω—Ñ–∏–≥
	config, err := pgxpool.ParseConfig(databaseURL)
	if err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∫–æ–Ω—Ñ–∏–≥–∞ –ë–î: %w", err)
	}

	// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã pool
	config.MaxConns = 25
	config.MinConns = 5
	config.MaxConnLifetime = time.Hour
	config.MaxConnIdleTime = 15 * time.Minute

	// –°–æ–∑–¥–∞—ë–º pool
	pool, err := pgxpool.NewWithConfig(ctx, config)
	if err != nil {
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è pool: %w", err)
	}

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
	if err := pool.Ping(ctx); err != nil {
		pool.Close()
		return nil, fmt.Errorf("–æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î: %w", err)
	}

	logger.Logger.Println("‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ")
	return pool, nil
}

// Setup –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ë–î: —Å–æ–∑–¥–∞—ë—Ç pool –∏ —Ç–∞–±–ª–∏—Ü—ã
func Setup(databaseURL string) (*pgxpool.Pool, error) {
	// 1. –°–æ–∑–¥–∞—ë–º pool
	pool, err := InitDB(databaseURL)
	if err != nil {
		return nil, err
	}

	// 2. –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—ã
	ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
	defer cancel()

	if err := booktags.CreateTables(ctx, pool); err != nil {
		pool.Close()
		return nil, err
	}

	return pool, nil
}


//-internal/repository/postgres/users/users.go-
package users

import (
	"HIGH_PR/internal/logger"
	"context"

	"github.com/jackc/pgx/v5/pgxpool"
)

// –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Ö—Ä–∞–Ω—è—â–∏–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∑–∞ –¥–µ–Ω—å!
func CreateTableUsers(ctx context.Context, pool *pgxpool.Pool) error {
	logger.Logger.Println("–°–æ–∑–¥–∞–Ω–µ —Ç–∞–±–ª–∏—Ü—ã —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏")
	createTableQuery := `
	CREATE TABLE IF NOT EXISTS daily_stats (

		date DATE PRIMARY KEY -- –î–∞—Ç–∞

		unique_users_count INT DEFAULT 0 --–ö–æ–ª-–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ—Å–µ—Ç–∏–≤—à–∏—Ö –±–æ—Ç–∞ –∑–∞ —É–∫–∞–∑ –¥–∞—Ç—É

		message_count INT DEFAULT 0 --–ö–æ–ª-–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π

		)


		-- –ò–Ω–¥–µ–∫—Å –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø–æ –¥–∞—Ç–µ (–¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤/–æ—Ç—á–µ—Ç–æ–≤)
		CREATE INDEX IF NOT EXISTS idx_daily_stats_date ON daily_stats(date DESC);
		`
	_, err := pool.Exec(ctx, createTableQuery)
	if err != nil {
		logger.Logger.Println("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã:", err)
		return err
	}

	logger.Logger.Println("–¢–∞–±–ª–∏—Ü—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã/–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã")
	return nil

}


//-internal/repository/postgres/bookTags/queryToDB.go-
package booktags

import (
	"context"
	"errors"
	"fmt"

	bookinfo "HIGH_PR/bookInfo"
	"HIGH_PR/internal/logger"

	"github.com/jackc/pgx/v5"
	"github.com/jackc/pgx/v5/pgxpool"
)

// BookRepository –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Å –∫–Ω–∏–≥–∞–º–∏ –≤ –ë–î
type BookRepository struct {
	pool *pgxpool.Pool
}

// NewBookRepository —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
func NewBookRepository(pool *pgxpool.Pool) *BookRepository {
	return &BookRepository{pool: pool}
}

// GetAllBooks –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –∫–Ω–∏–≥–∏ —Å —Ç–µ–≥–∞–º–∏
func (r *BookRepository) GetAllBooks(ctx context.Context) ([]BookWithTags, error) {
	logger.Logger.Println("–ó–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∫–Ω–∏–≥")

	sqlQuery := `SELECT
	b.id,
	b.title,
	b.authors,
	b.description,
	b.textSnippet,
	b.img,
	b.file_path,
	b.file_size,
	b.file_type,
	b.added_by,
	b.added_at,
	b.download_count,
	t.id,
	t.book_id,
	t.other_tag,
	t.lang,
	t.programming_lang
	FROM books b
	JOIN tags t ON b.id = t.book_id`

	rows, err := r.pool.Query(ctx, sqlQuery)
	if err != nil {
		return nil, err
	}
	defer rows.Close()

	var books []BookWithTags
	for rows.Next() {
		bt := BookWithTags{}
		err = rows.Scan(
			&bt.B.ID, &bt.B.Title, &bt.B.Authors, &bt.B.Description, &bt.B.TextSnippet, &bt.B.Img,
			&bt.B.FilePath, &bt.B.FileSize, &bt.B.FileType,
			&bt.B.AddedBy, &bt.B.AddedAt, &bt.B.DownloadCount,
			&bt.T.ID, &bt.T.BookID, &bt.T.OtherTag,
			&bt.T.Lang, &bt.T.ProgrammingLang,
		)
		if err != nil {
			return nil, err
		}
		books = append(books, bt)
	}

	if err := rows.Err(); err != nil {
		return nil, err
	}

	return books, nil
}

func (r *BookRepository) AddBook(ctx context.Context, bt BookWithTags) error {
	// –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
	tx, err := r.pool.Begin(ctx)
	if err != nil {
		return fmt.Errorf("failed to begin transaction: %w", err)
	}
	defer tx.Rollback(ctx) // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –µ—Å–ª–∏ –Ω–µ –∑–∞–∫–æ–º–º–∏—Ç–∏–º
	// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø–æ (title)
	var existingTitel string
	checkQuery := `SELECT id FROM books WHERE title = $1 LIMIT 1`
	err = tx.QueryRow(ctx, checkQuery, bt.B.Title).Scan(&existingTitel)
	if err == nil {
		return fmt.Errorf("–ö–Ω–∏–≥–∞ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ –µ—Å—Ç—å!")
	}
	// –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
	imgData, err := bookinfo.DownloadImage(bt.B.Img)
	if err != nil {
		logger.Logger.Printf("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–æ–∂–∫—É: %v", err)
		return err
	} else {
		bt.B.Img = imgData
	}
	//===================================

	// 1. –í—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–∏–≥—É
	query := `
	INSERT INTO books (title, authors, description, textSnippet, img, file_path, file_size, file_type, added_by, added_at, download_count)
	VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9,$10,$11)
	RETURNING id`

	var bookID int
	err = tx.QueryRow(ctx, query,
		bt.B.Title,
		bt.B.Authors,
		bt.B.Description,
		bt.B.TextSnippet,
		bt.B.Img,
		bt.B.FilePath,
		bt.B.FileSize,
		bt.B.FileType,
		bt.B.AddedBy,
		bt.B.AddedAt,
		bt.B.DownloadCount,
	).Scan(&bookID)
	if err != nil {
		return fmt.Errorf("failed to insert book: %w", err)
	}

	// 2. –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–≥–∏
	tagQuery := `
	INSERT INTO tags (book_id, other_tag, lang, programming_lang)
	VALUES ($1, $2, $3, $4)`

	_, err = tx.Exec(ctx, tagQuery,
		bookID,
		bt.T.OtherTag,
		bt.T.Lang,
		bt.T.ProgrammingLang,
	)
	if err != nil {
		return fmt.Errorf("failed to insert tags: %w", err)
	}

	// –ö–æ–º–º–∏—Ç–∏–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
	if err = tx.Commit(ctx); err != nil {
		return fmt.Errorf("failed to commit transaction: %w", err)
	}

	return nil
}

func (r *BookRepository) BookWithID(ctx context.Context, id int) (BookWithTags, error) {
	logger.Logger.Printf("–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–Ω–∏–≥–∏ |ID=%d|\n", id)

	sqlQuery := `
	SELECT
	b.id, b.title, b.authors, b.description, b.textSnippet, b.img,
	b.file_path, b.file_size, b.file_type,
	b.added_by, b.added_at, b.download_count,
	t.id, t.book_id, t.other_tag,
	t.lang, t.programming_lang
	FROM books b
	JOIN tags t ON b.id = t.book_id
	WHERE b.id = $1
	LIMIT 1
	`

	var bt BookWithTags
	err := r.pool.QueryRow(ctx, sqlQuery, id).Scan(
		&bt.B.ID, &bt.B.Title, &bt.B.Authors, &bt.B.Description, &bt.B.TextSnippet, &bt.B.Img,
		&bt.B.FilePath, &bt.B.FileSize, &bt.B.FileType,
		&bt.B.AddedBy, &bt.B.AddedAt, &bt.B.DownloadCount,
		&bt.T.ID, &bt.T.BookID, &bt.T.OtherTag,
		&bt.T.Lang, &bt.T.ProgrammingLang,
	)
	if err != nil {
		return BookWithTags{}, err
	}

	return bt, nil
}

func (r *BookRepository) GetFileBookWithID(ctx context.Context, id int) (string, error) {
	// –õ–æ–≥–≥–µ—Ä –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø–æ–≤—ã—à–µ (–≤ usecase), –Ω–æ –≤ —É—á–µ–±–Ω—ã—Ö —Ü–µ–ª—è—Ö –æ–∫.
	// logger.Logger.Println("–ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –∫–Ω–∏–≥–∏ –ø–æ ID")

	// –õ—É—á—à–µ –ø–∏—Å–∞—Ç—å –∑–∞–ø—Ä–æ—Å –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã,
	// –Ω–æ —Ç–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–∂–µ —á–∏—Ç–∞–µ–º.
	const sqlQuery = `SELECT file_path FROM books WHERE id = $1`

	var filePath string
	err := r.pool.QueryRow(ctx, sqlQuery, id).Scan(&filePath)
	if err != nil {
		// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—à–∏–±–∫–∞ –∏–º–µ–Ω–Ω–æ "–Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
		if errors.Is(err, pgx.ErrNoRows) {
			// –ú–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Å–ø–µ—Ü. –æ—à–∏–±–∫—É –∏–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ª–æ–≥–∏–∫–∏
			return "", fmt.Errorf("book with id %d not found: %w", id, pgx.ErrNoRows)
		}
		// –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
		return "", fmt.Errorf("repository.GetFileBookWithID: %w", err)
	}

	return filePath, nil
}

func (r *BookRepository) AddDownloadCountWithID(ctx context.Context, id int) error {
	sqlQuery := `
	UPDATE books
	SET download_count = download_count + 1
	WHERE id = $1
	`

	// –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
	commandTag, err := r.pool.Exec(ctx, sqlQuery, id)
	if err != nil {
		return fmt.Errorf("–Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫: %w", err)
	}

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–ø–∏—Å—å –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏–ª–∞—Å—å
	if commandTag.RowsAffected() == 0 {
		return fmt.Errorf("–∫–Ω–∏–≥–∞ —Å id=%d –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", id)
	}

	return nil
}

// ShowBooksWithTag –∏—â–µ—Ç –∫–Ω–∏–≥–∏, –≥–¥–µ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π —Ç–µ–≥ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è
// –ª–∏–±–æ –≤ programming_lang, –ª–∏–±–æ –≤ other_tag.
func (r *BookRepository) ShowBooksWithTag(ctx context.Context, tag string) ([]BookWithTags, error) {
	// –ú—ã –∏—â–µ–º –∫–Ω–∏–≥–∏, –≥–¥–µ –º–∞—Å—Å–∏–≤ programming_lang –°–û–î–ï–†–ñ–ò–¢ tag
	// –ò–õ–ò –º–∞—Å—Å–∏–≤ other_tag –°–û–î–ï–†–ñ–ò–¢ tag.
	// –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä && (–ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ) –∏ –ø—Ä–∏–≤–æ–¥–∏–º –Ω–∞—à –æ–¥–∏–Ω–æ—á–Ω—ã–π —Ç–µ–≥ –∫ –º–∞—Å—Å–∏–≤—É ARRAY[$1].
	sqlQuery := `
	SELECT
	b.id, b.title, b.authors, b.description, b.textSnippet, b.img,
	b.file_path, b.file_size, b.file_type,
	b.added_by, b.added_at, b.download_count,
	t.id, t.book_id, t.other_tag,
	t.lang, t.programming_lang
	FROM books b
	JOIN tags t ON b.id = t.book_id
	WHERE
	t.programming_lang && ARRAY[$1]::varchar[]
	OR
	t.other_tag && ARRAY[$1]::varchar[]
	`

	// –ü–µ—Ä–µ–¥–∞–µ–º tag –æ–¥–∏–Ω —Ä–∞–∑, –æ–Ω –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è –≤ $1
	rows, err := r.pool.Query(ctx, sqlQuery, tag)
	if err != nil {
		return nil, err
	}
	defer rows.Close()

	var books []BookWithTags

	for rows.Next() {
		var bt BookWithTags
		// –í–ê–ñ–ù–û: –ø–æ—Ä—è–¥–æ–∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–æ–ª–∂–µ–Ω —Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å SELECT
		err = rows.Scan(
			&bt.B.ID, &bt.B.Title, &bt.B.Authors, &bt.B.Description, &bt.B.TextSnippet, &bt.B.Img,
			&bt.B.FilePath, &bt.B.FileSize, &bt.B.FileType,
			&bt.B.AddedBy, &bt.B.AddedAt, &bt.B.DownloadCount,
			&bt.T.ID, &bt.T.BookID, &bt.T.OtherTag,
			&bt.T.Lang, &bt.T.ProgrammingLang,
		)
		if err != nil {
			return nil, err
		}
		books = append(books, bt)
	}

	if err := rows.Err(); err != nil {
		return nil, err
	}

	return books, nil
}

func (r *BookRepository) SearchBooksWithTitleDesc(ctx context.Context, query string) ([]BookWithTags, error) {
	// –í —Ñ—É–Ω–∫—Ü–∏–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏–ª–∏ main.go
	_, err := r.pool.Exec(ctx, "CREATE EXTENSION IF NOT EXISTS pg_trgm")
	if err != nil {
		// –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –æ–±—ã—á–Ω–æ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –º–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∏—Ç—å
		return nil, fmt.Errorf("failed to set similarity threshold: %w", err)
	}

	// 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä–æ–≥–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏/—Å–µ—Å—Å–∏–∏
	// 0.3-0.4 ‚Äî —Ö–æ—Ä–æ—à–∏–π –±–∞–ª–∞–Ω—Å. –ß–µ–º –≤—ã—à–µ —á–∏—Å–ª–æ, —Ç–µ–º —Å—Ç—Ä–æ–∂–µ –ø–æ–∏—Å–∫.
	_, err = r.pool.Exec(ctx, "SET pg_trgm.word_similarity_threshold = 0.3")
	if err != nil {
		return nil, fmt.Errorf("failed to set similarity threshold: %w", err)
	}

	// 2. SQL –∑–∞–ø—Ä–æ—Å —Å —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ–º
	sqlQuery := `
	SELECT
	b.id, b.title, b.authors, b.description, b.textSnippet, b.img,
	b.file_path, b.file_size, b.file_type,
	b.added_by, b.added_at, b.download_count,
	NULL::int, NULL::int, NULL::varchar[], NULL::varchar, NULL::varchar[]
	FROM books b
	WHERE
	($1::text <% b.title) OR ($1::text <% b.description)
	ORDER BY
	-- –ó–¥–µ—Å—å —Ç–æ–∂–µ –ª—É—á—à–µ —è–≤–Ω–æ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ text, —Ö–æ—Ç—è —Ñ—É–Ω–∫—Ü–∏–∏ –æ–±—ã—á–Ω–æ —É–º–Ω–µ–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
	GREATEST(word_similarity($1::text, b.title), word_similarity($1::text, b.description) * 0.6) DESC
	LIMIT 50;
	`

	rows, err := r.pool.Query(ctx, sqlQuery, query)
	if err != nil {
		return nil, err
	}
	defer rows.Close()

	var books []BookWithTags

	for rows.Next() {
		var bt BookWithTags
		// –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è NULL-–ø–æ–ª–µ–π —Ç–µ–≥–æ–≤ (—á—Ç–æ–±—ã Scan –Ω–µ —É–ø–∞–ª)
		var tID, tBookID *int
		var tOtherTag, tProgLang []string
		var tLang *string

		err = rows.Scan(
			&bt.B.ID, &bt.B.Title, &bt.B.Authors, &bt.B.Description, &bt.B.TextSnippet, &bt.B.Img,
			&bt.B.FilePath, &bt.B.FileSize, &bt.B.FileType,
			&bt.B.AddedBy, &bt.B.AddedAt, &bt.B.DownloadCount,
			&tID, &tBookID, &tOtherTag, &tLang, &tProgLang,
		)
		if err != nil {
			return nil, err
		}
		// –ú–æ–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å bt.T –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –Ω–æ –∑–¥–µ—Å—å –æ–Ω–∏ –ø—É—Å—Ç—ã–µ
		books = append(books, bt)
	}

	return books, nil
}

// –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥—É—Ç –¥—Ä—É–≥–∏–µ –º–µ—Ç–æ–¥—ã:
// func (r *BookRepository) GetByID(ctx context.Context, id int) (*Book, error) { ... }
// func (r *BookRepository) Create(ctx context.Context, book *Book) (int, error) { ... }
// func (r *BookRepository) Delete(ctx context.Context, id int) error { ... }


//-internal/repository/postgres/bookTags/booksTags.go-
package booktags

import (
	"context"

	"HIGH_PR/internal/logger"

	"github.com/jackc/pgx/v5/pgxpool"
)

// CreateTables —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
func CreateTables(ctx context.Context, pool *pgxpool.Pool) error {
	createTableQuery := `
	CREATE TABLE IF NOT EXISTS books (
		id SERIAL PRIMARY KEY,
		title VARCHAR(255) NOT NULL,
		authors VARCHAR(100)[],
		description TEXT,
		textsnippet TEXT,
		img VARCHAR(500),
		file_path VARCHAR(500),
		file_size BIGINT,
		file_type VARCHAR(10),
		added_by VARCHAR(50),
		added_at TIMESTAMP DEFAULT NOW(),
		download_count INT DEFAULT 0
		);

		CREATE INDEX IF NOT EXISTS idx_books_title ON books(title);

		CREATE TABLE IF NOT EXISTS tags (
			id SERIAL PRIMARY KEY,
			book_id INT NOT NULL REFERENCES books(id) ON DELETE CASCADE,
			lang VARCHAR(20),
			programming_lang VARCHAR(100)[],
			other_tag VARCHAR(100)[],
			UNIQUE(book_id)
			);

			CREATE INDEX IF NOT EXISTS idx_tags_book ON tags(book_id);
			CREATE INDEX IF NOT EXISTS idx_tags_other ON tags USING GIN (other_tag);
			CREATE INDEX IF NOT EXISTS idx_tags_programming_lang ON tags USING GIN (programming_lang);
			CREATE INDEX IF NOT EXISTS idx_tags_lang ON tags(lang);
			`

	_, err := pool.Exec(ctx, createTableQuery)
	if err != nil {
		logger.Logger.Println("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã:", err)
		return err
	}

	logger.Logger.Println("–¢–∞–±–ª–∏—Ü—ã —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω—ã/–ø—Ä–æ–≤–µ—Ä–µ–Ω—ã")
	return nil
}


//-internal/repository/postgres/bookTags/struct.go-
package booktags

import "time"

// Book –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç –∫–Ω–∏–≥—É –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
type Book struct {
	ID int

	Title string

	Authors []string

	Description string

	TextSnippet string

	Img string

	FilePath string
	FileSize int64 // –ö–æ–ª-–≤–æ –±–∞–π—Ç
	FileType string

	AddedBy string
	AddedAt time.Time

	DownloadCount int // –ö–æ–ª-–≤–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π
}

// Tag –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–µ–≥ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
type Tag struct {
	ID int

	BookID int

	OtherTag        []string
	Lang            string
	ProgrammingLang []string
}

// BookWithTags ‚Äî —É–¥–æ–±–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–Ω–∏–≥–∏ —Å–æ –≤—Å–µ–º–∏ —Ç–µ–≥–∞–º–∏
type BookWithTags struct {
	B Book
	T Tag
}


//-internal/logger/logger.go-
package logger

import (
	"io"
	"log"
	"os"

	"HIGH_PR/gl"
)

var (
	// Logger - –Ω–∞—à –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –ª–æ–≥–≥–µ—Ä–∞
	Logger  *log.Logger
	logFile *os.File // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–æ–≥–æ —Ñ–∞–π–ª–∞
)

// SetupLogger –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä
func SetupLogger(isDevMode bool) {
	var logOutput io.Writer
	var err error

	if isDevMode {
		// –í —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø–∏—à–µ–º –≤ –∫–æ–Ω—Å–æ–ª—å
		logOutput = os.Stdout
	} else {
		// –í –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ –ø–∏—à–µ–º –≤ —Ñ–∞–π–ª

		logFile, err = os.OpenFile(gl.LogPath, os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0o666)
		if err != nil {
			log.Fatalf("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –ª–æ–≥-—Ñ–∞–π–ª: %v", err)
		}
		logOutput = logFile
	}

	// –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ª–æ–≥–≥–µ—Ä
	Logger = log.New(logOutput, "INFO: ", log.LstdFlags|log.Lshortfile)
}

// Close –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Ñ–∞–π–ª –ª–æ–≥–∞, –µ—Å–ª–∏ –æ–Ω –±—ã–ª –æ—Ç–∫—Ä—ã—Ç.
// –£–¥–æ–±–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å —á–µ—Ä–µ–∑ defer –≤ main.
func Close() {
	if logFile != nil {
		err := logFile.Close()
		if err != nil {
			// –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ª–æ–≥–≥–µ—Ä –¥–ª—è —ç—Ç–æ–π –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π –æ—à–∏–±–∫–∏
			log.Printf("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –ª–æ–≥-—Ñ–∞–π–ª–∞: %v\n", err)
		}
	}
}


//-internal/bot/bot.go-
package bot

import (
	"context"
	"fmt"
	"log"
	"strings"
	"sync"

	"HIGH_PR/gl"
	"HIGH_PR/internal/services"

	"github.com/gotd/td/telegram"
	"github.com/gotd/td/tg"
)

// Bot ‚Äî –æ—Å–Ω–æ–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
// –û–Ω–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã.
type Bot struct {
	// –í–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ New)
	client *telegram.Client // MTProto –∫–ª–∏–µ–Ω—Ç –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Telegram API
	// bookService *services.BookService // –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–Ω–∏–≥–∞–º–∏
	logger *log.Logger // –ù–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –ª–æ–≥–≥–µ—Ä

	// –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
	dispatcher tg.UpdateDispatcher

	// –ü—É–ª –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–¥
	bookService *services.BookService
	mu          sync.Mutex
}

// WARNING
func New(
	client *telegram.Client,
	logger *log.Logger,
	dispatcher tg.UpdateDispatcher,
	bookService *services.BookService,
) *Bot {
	// –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –¥–∏—Å–ø–µ—Ç—á–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

	return &Bot{
		client:      client,
		logger:      logger,
		dispatcher:  dispatcher,
		bookService: bookService,
	}
}

func (b *Bot) Start(ctx context.Context) error {
	b.logger.Println("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤...")
	b.registerHandlers()

	return b.client.Run(ctx, func(ctx context.Context) error {
		// ‚≠ê –ü–†–ê–í–ò–õ–¨–ù–´–ô –í–ê–†–ò–ê–ù–¢: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
		status, err := b.client.Auth().Status(ctx)
		if err != nil {
			return fmt.Errorf("–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: %w", err)
		}

		// –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã
		if !status.Authorized {
			b.logger.Println("‚Üí –í—ã–ø–æ–ª–Ω—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –±–æ—Ç–∞...")
			if _, err := b.client.Auth().Bot(ctx, gl.BotToken); err != nil {
				return fmt.Errorf("–æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: %w", err)
			}
			b.logger.Println("‚úì –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, —Å–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞")
		} else {
			b.logger.Println("‚úì –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Å—Å–∏—é")
		}

		// –î–µ—Ä–∂–∏–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç—ã–º –¥–æ –æ—Ç–º–µ–Ω—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
		<-ctx.Done()
		return ctx.Err()
	})
}

func (b *Bot) registerHandlers() {
	// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
	b.dispatcher.OnNewMessage(func(ctx context.Context, e tg.Entities, update *tg.UpdateNewMessage) error {
		// –ü–µ—Ä–µ–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ –Ω–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
		b.handleMessage(ctx, e, update)
		return nil
	})
	b.dispatcher.OnBotCallbackQuery(func(ctx context.Context, e tg.Entities, update *tg.UpdateBotCallbackQuery) error {
		// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –Ω–∞ –∫–Ω–æ–ø–∫—É
		return b.handleCallback(ctx, e, update)
	})

	// –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –¥—Ä—É–≥–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏:
	// b.dispatcher.OnBotCallbackQuery(...)
	// b.dispatcher.OnInlineQuery(...)
}

// handleMessage ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ç–æ—Ä –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
func (b *Bot) handleMessage(ctx context.Context, e tg.Entities, update *tg.UpdateNewMessage) {
	// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è —Ç–µ–∫—Å—Ç–æ–≤—ã–º
	msg, ok := update.Message.(*tg.Message)
	if !ok || msg.Out {
		return // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–µ-—Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –∏—Å—Ö–æ–¥—è—â–∏–µ
	}

	b.logger.Printf("–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ: %s", msg.Message)

	text := msg.Message
	// –ü—Ä–æ—Å—Ç–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ —Ç–µ–∫—Å—Ç—É —Å–æ–æ–±—â–µ–Ω–∏—è (–∫–æ–º–∞–Ω–¥–µ)
	switch {
	case text == "/start":
		b.handleStart(ctx, e, msg)

	case strings.HasPrefix(text, "/add"):
		b.handleAddBook(ctx, e, msg, update)

	case text == "/show":
		b.handleShow(ctx, e, msg)

	case strings.HasPrefix(text, "/show_"):
		b.handleShowWithID(ctx, e, msg)

	case strings.HasPrefix(text, "/WithName"):
		b.handleShowWithName(ctx, e, msg)

	case text == "/help":
		b.handleHelp(ctx, e, msg)

	case text == "/admin":
		b.handleAdmin(ctx, e, msg)

	case strings.HasPrefix(text, "/FindWT"):
		b.handleTag(ctx, e, msg)
	case strings.HasPrefix(text, "/download_"):
		b.handleDownloadBook(ctx, e, msg)

	case strings.HasPrefix(text, "/search"):
		b.handleSearch(ctx, e, msg)
	default:
		// b.handleSearch(ctx, msg)
	}
}


//-internal/bot/fileOperation.go-
package bot

import (
	"bufio"
	"context"
	"fmt"
	"os"
	"path/filepath"
	"strings"

	"HIGH_PR/gl"

	"github.com/gotd/td/telegram/downloader"
	"github.com/gotd/td/telegram/message"
	"github.com/gotd/td/telegram/message/styling"
	"github.com/gotd/td/tg"
)

// –£–Ω–∏–≤–µ—Ä—Å–∫–∞–ª—å–Ω–∞—è –∫–æ—Å—Ç—ã–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ (–±–µ–∑ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–æ–±–∞–≤–∏—Ç—å caption) (–ù–æ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —É–∫–∞–∑–∞—Ç—å –∞—Ç—Ç—Ä–∏–±—É—Ç—ã —Ñ–∞–π–ª–∞ —Ç–∞–∫–∏–µ –∫–∞–∫ MIME –∏ —Ç–ø...)
// WARNING
func (b *Bot) SendFile(ctx context.Context, path string, sender *message.RequestBuilder) {
	upload := sender.Upload(message.FromPath(path))
	inputFile, err := upload.AsInputFile(ctx)
	if err != nil {
		b.logger.Printf("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è (inputFile): %v", err)
	}
	_, err = sender.Media(ctx,
		message.UploadedDocument(inputFile).
			MIME("text/plain").
			Filename("BOT_LOG.log"))
	if err != nil {
		b.logger.Printf("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: %v", err)
	}
}

func (b *Bot) SendLastLog(ctx context.Context, path string, sender *message.RequestBuilder) {
	lastStrLog, err := ReadLastLinesAsString(path, 20)
	if err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ —Å –ª–æ–≥–∞–º–∏!")
	}
	_, err = sender.StyledText(ctx, styling.Code(lastStrLog))
	if err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–∫–∏: ", err)
	}
}

func ReadLastLinesAsString(path string, n int) (string, error) {
	file, err := os.Open(path)
	if err != nil {
		return "", err
	}
	defer file.Close()

	var lines []string
	scanner := bufio.NewScanner(file)

	// –ß–∏—Ç–∞–µ–º –≤—Å–µ —Å—Ç—Ä–æ–∫–∏
	for scanner.Scan() {
		lines = append(lines, scanner.Text())
	}

	if err := scanner.Err(); err != nil {
		return "", err
	}

	// –ë–µ—Ä—ë–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å—Ç—Ä–æ–∫
	if len(lines) > n {
		lines = lines[len(lines)-n:]
	}

	// –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫
	return strings.Join(lines, "\n"), nil
}

func (b *Bot) DownloadFile(ctx context.Context, media *tg.MessageMediaDocument) error {
	b.logger.Println("–ó–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞!")
	doc, ok := media.Document.(*tg.Document)
	if !ok {
		return fmt.Errorf("–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç")
	}

	// –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å InputFileLocation –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
	location := &tg.InputDocumentFileLocation{
		ID:            doc.ID,
		AccessHash:    doc.AccessHash,
		FileReference: doc.FileReference,
		ThumbSize:     "", // –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ = –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª (–Ω–µ –ø—Ä–µ–≤—å—é)
	}

	// –®–∞–≥ 3: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—É—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
	filename := GetDocumentName(doc) // —Ç–≤–æ—è —Ñ—É–Ω–∫—Ü–∏—è
	savePath := filepath.Join(gl.DefaultSaveBook, filename)

	b.logger.Printf("üì• –ó–∞–≥—Ä—É–∑–∫–∞: %s", filename)

	// –®–∞–≥ 4: –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª
	_, err := downloader.NewDownloader().
		Download(b.client.API(), location).
		ToPath(ctx, savePath)
	if err != nil {
		return fmt.Errorf("–æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: %w", err)
	}

	b.logger.Printf("‚úÖ –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω: %s", savePath)
	return nil
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞
func GetDocumentName(doc *tg.Document) string {
	for _, attr := range doc.Attributes {
		if fn, ok := attr.(*tg.DocumentAttributeFilename); ok {
			return fn.FileName
		}
	}
	return "document.pdf"
}

func DeleteType(name string) string {
	res := strings.Replace(name, ".pdf", "", 1)
	return res
}

// –ü—Ä–æ—Å—Ç–∞—è –∏ –Ω–∞–¥—ë–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
func ExtractFileFormat(filename string) string {
	// filepath.Ext –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å —Ç–æ—á–∫–æ–π, –Ω–∞–ø—Ä–∏–º–µ—Ä ".pdf"
	ext := filepath.Ext(filename)

	// –£–±–∏—Ä–∞–µ–º —Ç–æ—á–∫—É –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
	format := strings.ToLower(strings.TrimPrefix(ext, "."))

	// –ï—Å–ª–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
	if format == "" {
		return "unknown"
	}

	return format
}


//-internal/bot/handlers.go-
package bot

import (
	"context"
	"fmt"
	"path/filepath"
	"strconv"
	"strings"
	"time"

	bookinfo "HIGH_PR/bookInfo"
	"HIGH_PR/gl"
	booktags "HIGH_PR/internal/repository/postgres/bookTags"

	"github.com/gotd/td/telegram/message"
	"github.com/gotd/td/tg"

	"github.com/gotd/td/telegram/message/markup"
	"github.com/gotd/td/telegram/message/peer"
	"github.com/gotd/td/telegram/uploader" // –¥–ª—è uploader.NewUploader
	//"os"
	//"time"
)

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ –±–¥ –∏ –æ—Ç–¥–∞–µ—Ç –≤—Å–µ –∫–Ω–∏–≥–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ (–ù–∞–∑–≤–∞–Ω–∏–µ, –ê–≤—Ç–æ—Ä—ã, –û–ø–∏—Å–∞–Ω–∏–µ, —Ç—ç–≥–∏)
func (b *Bot) handleShow(ctx context.Context, e tg.Entities, msg *tg.Message) {
	_, user, peer, err := getInfo(e, msg)
	b.logger.Printf("üì® /show –æ—Ç %s %s (@%s, ID:%d)",
		user.FirstName, user.LastName, user.Username, user.ID)

	if err != nil {
		b.logger.Println(err)
		return
	}

	// –í–´–ó–´–í–ê–ï–ú –°–ï–†–í–ò–° (–≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ë–î)
	books, err := b.bookService.GetAllBooks(ctx)
	if err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–Ω–∏–≥:", err)
		return
	}
	sender := message.NewSender(b.client.API()).To(peer)
	if len(books) != 0 {

		// –ü–µ—Ä–µ–¥–∞—ë–º –≥–æ—Ç–æ–≤—ã–µ –∫–Ω–∏–≥–∏ –≤ —Ñ—É–Ω–∫—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
		err = b.ShowBooksMessage(ctx, sender, books)
		if err != nil {
			b.logger.Println(err)
		}

	} else {
		sender.Text(ctx, "–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!")
	}
}

// ATTENTION
func (b *Bot) handleShowWithID(ctx context.Context, e tg.Entities, msg *tg.Message) {
	_, user, peer, err := getInfo(e, msg)
	messageText := strings.TrimSpace(msg.Message)
	// –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ /show_1
	idStr := messageText[6:] // –Ω–∞—á–∏–Ω–∞–µ–º —Å 6, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å "/show_"
	id, err := strconv.Atoi(idStr)
	if err != nil {
		b.logger.Printf("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ ID: %v", err)
		// –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
		return
	}

	b.logger.Printf("üì® /show_%d –æ—Ç %s %s (@%s, ID:%d)",
		id, user.FirstName, user.LastName, user.Username, user.ID)

	book, err := b.bookService.BookWithID(ctx, id)
	sender := message.NewSender(b.client.API()).To(peer)
	if err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ –∫ –±–¥. ERR = ", err)
		sender.Text(ctx, fmt.Sprintf("–û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞\nERR=%s", err))
		return
	}
	err = ShowBookWithIDMessage(ctx, b.client, peer, book)
	if err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ –≤ ShowBookWithIDMessage. ERR = ", err)
		sender.Text(ctx, fmt.Sprintf("ERR = %s", err))
	}

	b.logger.Println("–£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∏–Ω—Ñ–∞ –æ –∫–Ω–∏–≥–µ ID =", id)
}

func (b *Bot) handleShowWithName(ctx context.Context, e tg.Entities, msg *tg.Message) {
	_, user, peer, err := getInfo(e, msg)

	b.logger.Printf("üì® /showWithName –æ—Ç %s %s (@%s, ID:%d)",
		user.FirstName, user.LastName, user.Username, user.ID)
	if err != nil {
		b.logger.Println(err)
		return
	}
	text := msg.Message
	nameBook := strings.TrimPrefix(text, "/WithName")
	nameBook = strings.TrimSpace(nameBook)
	sender := message.NewSender(b.client.API()).To(peer)
	if len(nameBook) != 0 {
		res, err := bookinfo.SearchBooks(nameBook)
		if err != nil {
			b.logger.Println("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ Google API Books: ", err)
		}
		if res.Title == "" {
			b.logger.Println("–ù–µ –Ω–∞–π–¥–µ–Ω–æ")
			sender.Text(ctx, "–ö–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ ü´†ü´†ü´†\n–ü—Ä–æ–≤–µ—Ä—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ üçÑüçÑüçÑ")
			return

		}

		b.logger.Println("!!! –ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–Ω–∏–≥–∏: ", nameBook)

		sender.Text(ctx, fmt.Sprintf("–ù–∞–∑–≤–∞–Ω–∏–µ: %s\n\n–ê–≤—Ç–æ—Ä—ã: %v\n\n–û–ø–∏—Å–∞–Ω–∏–µ: %s\n", res.Title, res.Authors, res.Description))
	} else {
		b.logger.Println("–ù–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è!")
		sender.Text(ctx, "–£–∫–∞–∂–∏—Ç–µ –∏–º—è!")
	}
}

// ATTENTION
// –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—â–∞—è –∫–æ–º–∞–Ω–¥—É –∫–æ—Ç–æ—Ä–∞—è –æ—Ç–¥–∞–µ—Ç –∫–Ω–∏–≥—É –¥–ª—è —Å–∫–∏—á–∏–≤–∞–Ω–∏—è (–≤ –Ω–µ–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—å—Å—è ID, (—Ç–∞–∫–∂–µ —Å–¥–µ–ª–∞—é –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π –Ω–∞–∑–≤–∞–Ω–∏—è –∫–Ω–∏–≥ –≤ –∫–æ–º–∞–Ω–¥–µ show() –∫–æ—Ç–æ—Ä—ã–π –±—É–¥—É—Ç –¥–µ–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å —Å–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ–º –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å ID))
func (b *Bot) handleDownloadBook(ctx context.Context, e tg.Entities, msg *tg.Message) {
	// 1. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ
	_, user, peer, err := getInfo(e, msg)
	if err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ:", err)
		return
	}

	// 2. –ü–∞—Ä—Å–∏–º ID –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
	messageText := strings.TrimSpace(msg.Message)
	// –û–∂–∏–¥–∞–µ–º —Ñ–æ—Ä–º–∞—Ç "/download_123"
	if len(messageText) < 10 {
		return
	}
	idStr := messageText[10:] // –û—Ç—Ä–µ–∑–∞–µ–º "/download_"
	id, err := strconv.Atoi(idStr)
	if err != nil {
		b.logger.Printf("‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ ID: %v", err)
		// –¢—É—Ç –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å sender.Text(ctx, "–ù–µ–≤–µ—Ä–Ω—ã–π ID –∫–Ω–∏–≥–∏")
		return
	}

	b.logger.Printf("üì® –ó–∞–ø—Ä–æ—Å –∫–Ω–∏–≥–∏ ID:%d –æ—Ç %s (ID:%d)", id, user.FirstName, user.ID)
	err = b.bookService.AddDownloadCountWithID(ctx, id)
	if err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π: ", err)
	}

	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–µ–Ω–¥–µ—Ä
	sender := message.NewSender(b.client.API()).To(peer)

	// 3. –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É (—Ç–≤–æ—è –ª–æ–≥–∏–∫–∞)
	filePath, err := b.bookService.GetFileBookWithID(ctx, id)
	if err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–∞:", err)
		sender.Text(ctx, "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω.")
		return
	}

	// 4. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –≤ Telegram
	// uploader.NewUploader —Ä–∞–∑–±–∏–≤–∞–µ—Ç —Ñ–∞–π–ª –Ω–∞ —á–∞—Å—Ç–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö
	u := uploader.NewUploader(b.client.API())

	b.logger.Println("–ù–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞:", filePath)
	inputFile, err := u.FromPath(ctx, filePath)
	if err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (upload):", err)
		sender.Text(ctx, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.")
		return
	}

	// 5. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º InputMediaUploadedDocument [web:7][web:10]
	// –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ –º–µ–¥–∏–∞-–æ–±—ä–µ–∫—Ç
	// –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ Attributes, –∏–Ω–∞—á–µ –æ–Ω –ø—Ä–∏–¥–µ—Ç –∫–∞–∫ "file" –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
	fileName := filepath.Base(filePath)

	media := &tg.InputMediaUploadedDocument{
		File:     inputFile,
		MimeType: "application/pdf", // –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —Ä–µ–∞–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "application/pdf")
		Attributes: []tg.DocumentAttributeClass{
			&tg.DocumentAttributeFilename{FileName: fileName}, // –ß—Ç–æ–±—ã —É —Ñ–∞–π–ª–∞ –±—ã–ª–æ –∏–º—è
		},
		ForceFile: true, // –§–æ—Ä—Å–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –∏–º–µ–Ω–Ω–æ –∫–∞–∫ —Ñ–∞–π–ª (–¥–æ–∫—É–º–µ–Ω—Ç)
	}

	// 6. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ Media(), –∞ –Ω–µ Document()
	// Document() –∂–¥–µ—Ç tg.InputDocument (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª), –∞ –º—ã —à–ª–µ–º tg.InputMedia (–Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç)
	if _, err := sender.Media(ctx, message.Media(media)); err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–¥–∏–∞:", err)
		sender.Text(ctx, fmt.Sprintf("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª: %s", err))
		return
	}

	b.logger.Println("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!")
}

// handleStart –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /start
func (b *Bot) handleStart(ctx context.Context, e tg.Entities, msg *tg.Message) {
	_, user, peer, err := getInfo(e, msg)
	if err != nil {
		b.logger.Println(err)
	}

	b.logger.Printf("üì® /start –æ—Ç %s %s (@%s, ID:%d)",
		user.FirstName,
		user.LastName,
		user.Username,
		user.ID)

	// 6. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç

	// WARNING

	// –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ —Å–Ω–∏–∑—É –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–∞–±–æ—Ç—É —Å —Å—ã—Ä—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ (–≤ –¥–∞–Ω–Ω–æ–º –ø—Ä–∏–º–µ—Ä–µ –ø—Ä–µ–¥—Å–∞–≤–ª–µ–Ω–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–Ω–µ inline!))

	// // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º random ID (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å time.Now().UnixNano())
	// randomID := time.Now().UnixNano()
	//
	// // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —É–¥–∞–ª–µ–Ω–∏–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
	// _, err = b.client.API().MessagesSendMessage(ctx, &tg.MessagesSendMessageRequest{
	// 	Peer:     peer,
	// 	Message:  fmt.Sprintf("–ü—Ä–∏–≤–µ—Ç, %s! üëã", user.FirstName),
	// 					    RandomID: randomID,  // –í–û–¢ –≠–¢–û –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û!
	// 					    ReplyMarkup: &tg.ReplyKeyboardHide{
	// 						    Selective: false,
	// 					    },
	// })

	_, err = b.client.API().MessagesSendMessage(ctx, &tg.MessagesSendMessageRequest{
		Peer:     peer, // –ø–æ–ª—É—á–∞—Ç–µ–ª—å
		Message:  fmt.Sprintf("–ü—Ä–∏–≤–µ—Ç, %s! üëã", user.FirstName),
		RandomID: time.Now().UnixNano(), // –≤—Å–µ–≥–¥–∞ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π
	})
	u := uploader.NewUploader(b.client.API()).
		WithPartSize(512 * 1024). // 512 KB (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —á–∞–Ω–∫)
		WithThreads(4)

	// 2. –£–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É
	// –í–∞–∂–Ω–æ: —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ .webp (–¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Å—Ç–∏–∫–µ—Ä–æ–≤)
	filePath := "/home/magamed/–†–∞–±–æ—á–∏–π —Å—Ç–æ–ª/MyPet/TG/HIGH_PR/sticker/hello.webp"

	// 3. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–∞ Telegram
	// FromPath —Å–∞–º –æ—Ç–∫—Ä–æ–µ—Ç —Ñ–∞–π–ª –∏ –∑–∞–≥—Ä—É–∑–∏—Ç –µ–≥–æ
	upload, err := u.FromPath(ctx, filePath)
	if err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞:", err)
	}
	sender := message.NewSender(b.client.API()).To(peer)
	// 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∏–º–µ–Ω–Ω–æ –∫–∞–∫ –°–¢–ò–ö–ï–†
	// –ú–µ—Ç–æ–¥ UploadedSticker –±–µ—Ä–µ—Ç —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –∏ –¥–µ–ª–∞–µ—Ç –∏–∑ –Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
	_, err = sender.UploadedSticker(ctx, upload)
	if err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∏–∫–µ—Ä–∞:", err)
	}

	if err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º:", err)
	}
}

// handleHelp –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /help
func (b *Bot) handleHelp(ctx context.Context, e tg.Entities, msg *tg.Message) {
	_, user, peer, err := getInfo(e, msg)
	if err != nil {
		b.logger.Println(err)
	}

	b.logger.Printf("üì® /help –æ—Ç %s %s (@%s, ID:%d)",
		user.FirstName,
		user.LastName,
		user.Username,
		user.ID)
	sender := message.NewSender(b.client.API()).To(peer)
	text := b.SendHelpMessage(ctx)
	_, err = sender.StyledText(ctx, text...)
	if err != nil {
		b.logger.Println("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è! ", err)
	}
}

// handleAddBook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /add
func (b *Bot) handleAddBook(ctx context.Context, e tg.Entities, msg *tg.Message, update *tg.UpdateNewMessage) {
	txt := strings.TrimSpace(msg.Message)
	_, user, peer, err := getInfo(e, msg)
	b.logger.Printf("üì® /add –æ—Ç %s %s (@%s, ID:%d)",
		user.FirstName, user.LastName, user.Username, user.ID)
	if err != nil {
		b.logger.Println(err)
		return
	}
	sender := message.NewSender(b.client.API()).To(peer)
	media, ok := msg.Media.(*tg.MessageMediaDocument)
	if !ok {
		b.logger.Println("–ö–æ–º–∞–Ω–¥–∞ /add –±–µ–∑ —Ñ–∞–π–ª–∞!")
		_, err = sender.Text(ctx, "–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–∞–Ω–¥—É /add –∏ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª!")
		if err != nil {
			b.logger.Printf("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: %v", err)
		}
		return
	}
	doc, ok := media.Document.(*tg.Document)
	if !ok {
		b.logger.Println("–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç")
	}

	if txt == "/add" {
		fullName := GetDocumentName(doc)
		name := DeleteType(fullName)
		info, err := bookinfo.SearchBooks(name)
		fileType := ExtractFileFormat(fullName)
		if err != nil {
			b.logger.Println("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–Ω–∏–≥–µ!")
			sender.Text(ctx, "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–Ω–∏–≥–∏ –∏–∑ Google Book API")
			sender.Text(ctx, "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –≤ —Ä—É—á–Ω—É—é! (/add –ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏...+—Ñ–∞–π–ª)")
			return
		}
		langTag, otherTag, err := bookinfo.ParseMetadataFromInfo(info.Title, info.Description)
		if err != nil {
			b.logger.Println("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∞ —Ç—ç–≥–∞")
		}

		err = b.bookService.AddBook(ctx, booktags.BookWithTags{
			B: booktags.Book{
				Title:       info.Title,
				Authors:     info.Authors,
				Description: info.Description,
				TextSnippet: info.TextSnippet,
				FileSize:    doc.Size,
				Img:         info.Img,
				FileType:    fileType,
				FilePath:    gl.DefaultSaveBook + "/" + fullName,
				AddedBy:     user.Username,
				AddedAt:     time.Now().Truncate(time.Second),
			},
			T: booktags.Tag{
				Lang:            info.Lang,
				ProgrammingLang: []string{langTag},
				OtherTag:        []string{otherTag},
			},
		})
		if err != nil {
			b.logger.Println("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–∏–≥–∏ –≤ –±–¥:", err)
			sender.Text(ctx, fmt.Sprintf("ERR=%s", err))
			return
		}

		err = b.DownloadFile(ctx, media)
		if err != nil {
			b.logger.Println("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ", err)
			_, err = sender.Text(ctx, fmt.Sprintf("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞!\nError: %s", err))
			if err != nil {
				b.logger.Printf("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: %v", err)
			}
			return
		}
		_, err = sender.Text(ctx, "–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!")
		if err != nil {
			b.logger.Printf("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: %v", err)
		}

	} else {
		nameBook := strings.TrimPrefix(txt, "/add")

		fullName := GetDocumentName(doc)
		info, err := bookinfo.SearchBooks(nameBook)
		fileType := ExtractFileFormat(fullName)

		if err != nil {
			b.logger.Println("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–Ω–∏–≥–µ!")
			sender.Text(ctx, "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–Ω–∏–≥–∏ –∏–∑ Google Book API")
		}

		langTag, otherTag, err := bookinfo.ParseMetadataFromInfo(info.Title, info.Description)
		if err != nil {
			b.logger.Println("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∞ —Ç—ç–≥–∞")
		}

		err = b.bookService.AddBook(ctx, booktags.BookWithTags{
			B: booktags.Book{
				Title:       info.Title,
				Authors:     info.Authors,
				Description: info.Description,
				TextSnippet: info.TextSnippet,
				FileSize:    doc.Size,
				Img:         info.Img,
				FileType:    fileType,
				FilePath:    gl.DefaultSaveBook + "/" + fullName,
				AddedBy:     user.Username,
				AddedAt:     time.Now().Truncate(time.Second),
			},
			T: booktags.Tag{
				Lang:            info.Lang,
				ProgrammingLang: []string{langTag},
				OtherTag:        []string{otherTag},
			},
		})
		if err != nil {
			b.logger.Println("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–Ω–∏–≥–∏ –≤ –±–¥:", err)
			sender.Text(ctx, fmt.Sprintf("ERR=%s", err))
			return
		}

		err = b.DownloadFile(ctx, media)
		if err != nil {
			b.logger.Println("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ", err)
			_, err = sender.Text(ctx, fmt.Sprintf("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞!\nError: %s", err))
			if err != nil {
				b.logger.Printf("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: %v", err)
			}
			return
		}
		_, err = sender.Text(ctx, fmt.Sprint("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!"))
		if err != nil {
			b.logger.Printf("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: %v", err)
		}

	}
}

func (b *Bot) handleAdmin(ctx context.Context, e tg.Entities, msg *tg.Message) {
	_, user, peer, err := getInfo(e, msg)
	if err != nil {
		b.logger.Println(err)
	}

	b.logger.Printf("üì® /admin –æ—Ç %s %s (@%s, ID:%d)",
		user.FirstName,
		user.LastName,
		user.Username,
		user.ID)

	sender := message.NewSender(b.client.API()).To(peer)
	adminID, _ := strconv.ParseInt(gl.AdminID, 10, 64)

	if user.ID != adminID {
		_, err = sender.Text(ctx, fmt.Sprintf("–ü—Ä–∏–≤–µ—Ç, %s! üëã\n–î–æ—Å—Ç—É–ø –ó–∞–ø—Ä–µ—â–µ–Ω!", user.Username))
		if err != nil {
			b.logger.Printf("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: %v", err)
		}
	} else {
		_, err := sender.
			Markup(markup.InlineRow(
				markup.Callback("All_Log", []byte("FileLog")),
				markup.Callback("Last_Log", []byte("LastLog")),
			)).
			Text(ctx, fmt.Sprintf("–ü—Ä–∏–≤–µ—Ç –º–æ–π –ø–æ–≤–µ–ª–∏—Ç–µ–ª—å %s", user.Username))
		if err != nil {
			b.logger.Printf("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: %v", err)
		}
		// –í—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª

	}
}

// WARNING
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏–µ id, —é–∑–µ—Ä–∞ –∏ peer
func getInfo(e tg.Entities, msg *tg.Message) (int64, *tg.User, tg.InputPeerClass, error) {
	var userID int64
	var user *tg.User
	var ok bool

	entities := peer.NewEntities(e.Users, e.Chats, e.Channels)

	// 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º FromID (–≤—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
	if fromID, hasFromID := msg.GetFromID(); hasFromID {
		if peerUser, isPeerUser := fromID.(*tg.PeerUser); isPeerUser {
			userID = peerUser.UserID
		}
	}

	// 2. –ï—Å–ª–∏ FromID –ø—É—Å—Ç–æ–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º PeerID (–¥–ª—è –ª–∏—á–Ω—ã—Ö —á–∞—Ç–æ–≤)
	if userID == 0 {
		if peerID, ok := msg.PeerID.(*tg.PeerUser); ok {
			userID = peerID.UserID
		}
	}

	// 3. –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ –Ω–∞—à–ª–∏, —ç—Ç–æ –≥—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞
	if userID == 0 {
		return 0, nil, nil, fmt.Errorf("–Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
	}

	// 4. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	user, ok = entities.User(userID)
	if !ok {
		return 0, nil, nil, fmt.Errorf("–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å %d –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Entities", userID)
	}

	peer, err := entities.ExtractPeer(msg.PeerID)
	if err != nil {
		return 0, nil, nil, fmt.Errorf("–æ—à–∏–±–∫–∞ ExtractPeer: %v", err)
	}
	return userID, user, peer, nil
}

func (b *Bot) handleTag(ctx context.Context, e tg.Entities, msg *tg.Message) {
	_, user, peer, err := getInfo(e, msg)
	if err != nil {
		b.logger.Println(err)
	}

	b.logger.Printf("üì® /FindWT –æ—Ç %s %s (@%s, ID:%d)",
		user.FirstName,
		user.LastName,
		user.Username,
		user.ID)

	txt := strings.TrimPrefix(msg.Message, "/FindWT")
	txt = strings.TrimSpace(txt)

	books, err := b.bookService.ShowBooksWithTag(ctx, txt)
	if err != nil {
		b.logger.Println(err)
	}
	sender := message.NewSender(b.client.API()).To(peer)
	if len(books) != 0 {

		// –ü–µ—Ä–µ–¥–∞—ë–º –≥–æ—Ç–æ–≤—ã–µ –∫–Ω–∏–≥–∏ –≤ —Ñ—É–Ω–∫—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
		err = b.ShowBooksMessage(ctx, sender, books)
		if err != nil {
			b.logger.Println(err)
		}

	} else {
		sender.Text(ctx, "–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!")
	}
}

func (b *Bot) handleSearch(ctx context.Context, e tg.Entities, msg *tg.Message) {
	_, user, peer, err := getInfo(e, msg)
	if err != nil {
		b.logger.Println(err)
	}

	b.logger.Printf("üì® /search –æ—Ç %s %s (@%s, ID:%d)",
		user.FirstName,
		user.LastName,
		user.Username,
		user.ID)

	txt := strings.TrimPrefix(msg.Message, "/search")
	txt = strings.TrimSpace(txt)
	sender := message.NewSender(b.client.API()).To(peer)
	if txt == "" {
		sender.Text(ctx, "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!")
		return
	}
	books, err := b.bookService.SearchBooksWithTitleDesc(ctx, txt)
	if err != nil {
		b.logger.Println("Search Error:", err)
		// ... —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ ...
		return
	}
	if len(books) != 0 {

		// –ü–µ—Ä–µ–¥–∞—ë–º –≥–æ—Ç–æ–≤—ã–µ –∫–Ω–∏–≥–∏ –≤ —Ñ—É–Ω–∫—Ü–∏—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
		err = b.ShowBooksMessage(ctx, sender, books)
		if err != nil {
			b.logger.Println(err)
		}
	} else {
		sender.Text(ctx, "–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!")
	}
}


//-internal/bot/editMessage.go-
// –≠—Ç–æ—Ç —Ñ–∞–π–ª –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ –æ—Ñ—Ä–º–µ–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π! (–µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ–µ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ–≥–¥–∞ –æ–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤ –¥–∞–Ω–Ω–æ–º —Ñ–∞–π–ª–µ!)
package bot

import (
	"context"
	"fmt"
	"strings"
	"time"

	booktags "HIGH_PR/internal/repository/postgres/bookTags"

	"github.com/gotd/td/telegram/message/markup"

	"github.com/dustin/go-humanize"
	"github.com/gotd/td/telegram"
	"github.com/gotd/td/telegram/message"
	"github.com/gotd/td/telegram/message/entity"
	"github.com/gotd/td/telegram/message/styling"
	"github.com/gotd/td/telegram/uploader"
	"github.com/gotd/td/tg"
)

// buildBookPage —Å–æ–±–∏—Ä–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
func (b *Bot) buildBookPage(books []booktags.BookWithTags, page int) ([]styling.StyledTextOption, tg.ReplyMarkupClass) {
	const booksPerPage = 3
	totalBooks := len(books)

	// 1. –°—á–∏—Ç–∞–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
	totalPages := (totalBooks + booksPerPage - 1) / booksPerPage
	if page < 0 {
		page = 0
	}
	if page >= totalPages {
		page = totalPages - 1
	}

	start := page * booksPerPage
	end := start + booksPerPage
	if end > totalBooks {
		end = totalBooks
	}

	// 2. –°—Ç—Ä–æ–∏–º —Ç–µ–∫—Å—Ç (—Ç—É—Ç —Ç–≤–æ–π –∫–æ–¥ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è)
	var text []styling.StyledTextOption
	text = append(text, styling.Plain(fmt.Sprintf("üìñ –ö–Ω–∏–≥–∏ (–°—Ç—Ä. %d/%d)\n\n", page+1, totalPages)))

	for i := start; i < end; i++ {
		var authors string
		if len(books[i].B.Authors) > 2 {
			authors = books[i].B.Authors[0] + ", " + books[i].B.Authors[1] + " ..."
		} else {
			authors = strings.Join(books[i].B.Authors, ", ")
		}

		text = append(text,
			styling.Bold("üìö –ù–∞–∑–≤–∞–Ω–∏–µ: "),
			styling.Plain(books[i].B.Title+"\n\n"),

			styling.Bold("üë®‚Äçüíº –ê–≤—Ç–æ—Ä—ã: "),
			styling.Plain(authors+"\n\n"),

			styling.Bold("üìù –û–ø–∏—Å–∞–Ω–∏–µ:\n"),
			styling.Italic("    "+books[i].B.TextSnippet+"\n\n"),

			styling.Custom(func(eb *entity.Builder) error {
				eb.Format("üîó –°–∫–∞—á–∞—Ç—å:", entity.Bold())
				return nil
			}),
			styling.Plain(fmt.Sprintf(" /download_%d\n", books[i].B.ID)),

			styling.Custom(func(eb *entity.Builder) error {
				eb.Format("üîé –ü–æ–¥—Ä–æ–±–Ω–µ–µ:", entity.Bold())
				return nil
			}),
			styling.Plain(fmt.Sprintf(" /show_%d\n", books[i].B.ID)),

			styling.Plain("\n"),
			styling.Plain("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"),
			styling.Plain("\n\n"),
		)
	}

	// 3. –°—Ç—Ä–æ–∏–º –∫–Ω–æ–ø–∫–∏. –í–ù–ò–ú–ê–ù–ò–ï: –º—ã —Å—Ä–∞–∑—É –ø–∏—à–µ–º –Ω–æ–º–µ—Ä –ù–£–ñ–ù–û–ô —Å—Ç—Ä–∞–Ω–∏—Ü—ã
	var rows []tg.KeyboardButtonClass

	// –ï—Å–ª–∏ –Ω–µ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -> –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" –≤–µ–¥–µ—Ç –Ω–∞ (page - 1)
	if page > 0 {
		rows = append(rows, markup.Callback("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", []byte(fmt.Sprintf("page:%d", page-1))))
	}

	// –ï—Å–ª–∏ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ -> –∫–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥" –≤–µ–¥–µ—Ç –Ω–∞ (page + 1)
	if page < totalPages-1 {
		rows = append(rows, markup.Callback("–í–ø–µ—Ä–µ–¥ ‚û°Ô∏è", []byte(fmt.Sprintf("page:%d", page+1))))
	}
	if len(rows) == 0 {
		return text, nil
	}

	return text, markup.InlineRow(rows...)
}

// –ë–´–õ–û: func ShowBooksMessage(ctx context.Context, msg *message.RequestBuilder, pool *pgxpool.Pool)
// –°–¢–ê–õ–û:
func (b *Bot) ShowBooksMessage(ctx context.Context, msg *message.RequestBuilder, books []booktags.BookWithTags) error {
	// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∞–º—É—é –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (0)
	text, keyboard := b.buildBookPage(books, 0)

	_, err := msg.Markup(keyboard).StyledText(ctx, text...)
	return err
}

func calculatePageCount(totalBooks, booksPerPage int) int {
	return (totalBooks + booksPerPage - 1) / booksPerPage
}

func formatAuthors(authors []string) string {
	return strings.Join(authors, ", ")
}

func ShowBookWithIDMessage(ctx context.Context, client *telegram.Client, peer tg.InputPeerClass, book booktags.BookWithTags) error {
	// 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Uploader
	uploader := uploader.NewUploader(client.API())
	inpF, err := uploader.FromPath(ctx, book.B.Img)
	if err != nil {
		return fmt.Errorf("upload error: %w", err)
	}

	// 2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
	randomID := time.Now().UnixNano()
	media := &tg.InputMediaUploadedPhoto{File: inpF}
	fileSize := humanize.Bytes(uint64(book.B.FileSize))
	addedAt := book.B.AddedAt.Format("02.01.2006 15:04")

	// –û–±—Ä–µ–∑–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞—Ä–∞–Ω–µ–µ
	desc := book.B.Description
	// –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Å—Ä–µ–∑ —Ä—É–Ω (—Å–∏–º–≤–æ–ª–æ–≤)
	descRunes := []rune(desc)

	// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –∏–º–µ–Ω–Ω–æ –≤ —Å–∏–º–≤–æ–ª–∞—Ö
	if len(descRunes) > 600 {
		// –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ–±—Ä–µ–∑–∞–µ–º –ø–æ —Å–∏–º–≤–æ–ª–∞–º –∏ —Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ —Å—Ç—Ä–æ–∫—É
		desc = string(descRunes[:597]) + "..."
	}

	// 3. –ò–°–ü–û–õ–¨–ó–£–ï–ú entity.Builder –í–ú–ï–°–¢–û styling
	// Builder —Å–∞–º –ø–æ—Å—á–∏—Ç–∞–µ—Ç –≤—Å–µ —Å–º–µ—â–µ–Ω–∏—è (offsets/lengths)
	// –Ø–ü
	var langProg string
	if book.T.ProgrammingLang[0] == "" {
		langProg = "-"
	} else {
		langProg = book.T.ProgrammingLang[0]
	}

	// –Ø–∑—ã–∫ –∫–Ω–∏–≥–∏
	langMap := map[string]string{
		"ru": "üá∑üá∫ –†—É—Å—Å–∫–∏–π",
		"en": "üá¨üáß –ê–Ω–≥–ª–∏–π—Å–∫–∏–π",
		// –¥–æ–±–∞–≤—å –¥—Ä—É–≥–∏–µ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
	}

	var b entity.Builder

	b.Bold("üìö –ù–∞–∑–≤–∞–Ω–∏–µ: ")
	b.Plain(book.B.Title + "\n\n")

	b.Bold("üë®‚Äçüíº –ê–≤—Ç–æ—Ä—ã: ")
	b.Plain(formatAuthors(book.B.Authors) + "\n\n")

	b.Bold("üìù –û–ø–∏—Å–∞–Ω–∏–µ:\n")
	b.Italic("    " + desc + "\n\n")

	b.Bold("üíæ –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: ")
	b.Plain(fileSize + "\n")

	b.Bold("üóÇ –¢–∏–ø —Ñ–∞–π–ª–∞: ")
	b.Plain(book.B.FileType + "\n")

	b.Bold("üìÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: ")
	b.Plain(addedAt + "\n")

	b.Bold("‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–π: ")
	b.Plain(fmt.Sprintf("%d\n", book.B.DownloadCount))

	b.Bold("üåê –Ø–∑—ã–∫: ")
	b.Plain(langMap[book.T.Lang] + "\n")

	b.Bold("üíª –Ø–ü: ")
	b.Plain(langProg + "\n")

	b.Bold("üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏—è: ")
	b.Plain(book.T.OtherTag[0] + "\n")

	// 4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∏ entities
	captionText, entities := b.Complete()

	keyboard := markup.InlineRow(markup.Callback("–°–∫–∞—á–∞—Ç—å", []byte(fmt.Sprintf("download:%d", book.B.ID))))

	// 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
	_, err = client.API().MessagesSendMedia(ctx, &tg.MessagesSendMediaRequest{
		Peer:        peer,
		Message:     captionText,
		RandomID:    randomID,
		Media:       media,
		Entities:    entities, // –¢–µ–ø–µ—Ä—å —Ç–∏–ø —Å–æ–≤–ø–∞–¥–∞–µ—Ç ([]tg.MessageEntityClass)
		ReplyMarkup: keyboard,
	})

	return err
}

// SendHelpMessage –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é
func (b *Bot) SendHelpMessage(ctx context.Context) []styling.StyledTextOption {
	// –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º styling.Plain, styling.Bold, styling.Code –∏ styling.Italic
	// —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–∞–∫ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä.
	var text []styling.StyledTextOption
	text = append(text,
		// –ó–∞–≥–æ–ª–æ–≤–æ–∫
		styling.Bold("ü§ñ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í–æ—Ç —á—Ç–æ —è —É–º–µ—é:\n\n"),

		// --- –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã ---
		styling.Plain("üöÄ "),
		styling.Plain("/start"),
		styling.Plain(" ‚Äî –ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º.\n\n"),

		styling.Plain("üìö "),
		styling.Plain("/show"),
		styling.Plain(" ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–Ω–∏–≥.\n\n"),

		// --- –†–∞–±–æ—Ç–∞ —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–Ω–∏–≥–æ–π ---
		styling.Plain("üîç "),
		styling.Code("/show_num"),
		styling.Plain(" ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ –ø–æ –µ—ë ID.\n"),
		styling.Italic("–ü—Ä–∏–º–µ—Ä: /show_1\n\n"),

		styling.Plain("‚¨áÔ∏è "),
		styling.Code("/download_num"),
		styling.Plain(" ‚Äî –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª –∫–Ω–∏–≥–∏ –ø–æ –µ—ë ID.\n"),
		styling.Italic("–ü—Ä–∏–º–µ—Ä: /download_2\n\n"),

		// --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–∏–≥ ---
		styling.Bold("üì• –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–∏–≥:\n"),
		styling.Plain("–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ñ–∞–π–ª —Å –∫–æ–º–∞–Ω–¥–æ–π –≤ –ø–æ–¥–ø–∏—Å–∏:\n\n"),

		styling.Plain("1Ô∏è‚É£ "),
		styling.Code("/add"),
		styling.Plain(" ‚Äî –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ.\n"),
		styling.Italic("(–ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª –∫–Ω–∏–≥–∏ –∫ —ç—Ç–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é)\n\n"),

		styling.Plain("2Ô∏è‚É£ "),
		styling.Code("/add <–ù–∞–∑–≤–∞–Ω–∏–µ>"),
		styling.Plain(" ‚Äî –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –≤—Ä—É—á–Ω—É—é.\n"),
		styling.Italic("–ò—Å–ø–æ–ª—å–∑—É–π, –µ—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –æ—à–∏–±–ª–∞—Å—å.\n"),
		styling.Italic("(–ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª –∫–Ω–∏–≥–∏ –∫ —ç—Ç–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é)"),
	)
	return text
}


//-internal/bot/buttonHandlers.go-
package bot

import (
	"context"
	"fmt"
	"path/filepath"
	"strconv"
	"strings"

	"HIGH_PR/gl"

	"github.com/gotd/td/telegram/message"
	"github.com/gotd/td/telegram/uploader"
	"github.com/gotd/td/tg"
)

func (b *Bot) handleCallback(
	ctx context.Context,
	e tg.Entities,
	update *tg.UpdateBotCallbackQuery,
) error {
	data := string(update.Data)
	switch {
	case strings.HasPrefix(data, "page:"):
		pageStr := strings.TrimPrefix(data, "page:")
		targetPage, _ := strconv.Atoi(pageStr)

		// 1. –ü–æ–ª—É—á–∞–µ–º –∫–Ω–∏–≥–∏
		books, err := b.bookService.GetAllBooks(ctx)
		if err != nil {
			_ = b.answerCallback(ctx, update.QueryID, "–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö")
			return err
		}

		// 2. –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤—É
		newText, newKeyboard := b.buildBookPage(books, targetPage)

		// 3. –°–æ–±–∏—Ä–∞–µ–º InputPeer "–≤—Ä—É—á–Ω—É—é"
		var inputPeer tg.InputPeerClass

		switch p := update.Peer.(type) {
		case *tg.PeerUser:
			user, ok := e.Users[p.UserID]
			if !ok {
				return nil
			}
			inputPeer = &tg.InputPeerUser{
				UserID:     user.ID,
				AccessHash: user.AccessHash,
			}
		case *tg.PeerChat:
			inputPeer = &tg.InputPeerChat{
				ChatID: p.ChatID,
			}
		case *tg.PeerChannel:
			ch, ok := e.Channels[p.ChannelID]
			if !ok {
				return nil
			}
			inputPeer = &tg.InputPeerChannel{
				ChannelID:  ch.ID,
				AccessHash: ch.AccessHash,
			}
		}

		if inputPeer == nil {
			return nil
		}

		// 4. –†–ï–î–ê–ö–¢–ò–†–£–ï–ú —Å–æ–æ–±—â–µ–Ω–∏–µ
		sender := message.NewSender(b.client.API())

		_, err = sender.
			To(inputPeer).              // -> *message.RequestBuilder (Builder)
			Markup(newKeyboard).        // Markup –µ—Å—Ç—å –¢–û–õ–¨–ö–û —Ç—É—Ç [web:1]
			Edit(update.MsgID).         // -> *EditMessageBuilder
			StyledText(ctx, newText...) // —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∏ —Å—É—â–Ω–æ—Å—Ç–∏ [web:1][web:21]

		// 5. –£–±–∏—Ä–∞–µ–º "—á–∞—Å–∏–∫–∏"
		_ = b.answerCallback(ctx, update.QueryID, "")

		return err

	case data == "FileLog":

		sender := message.NewSender(b.client.API()).Peer(e, update)
		if err := b.handleButtonAllLog(ctx, sender); err != nil {
			return err
		}
	case data == "LastLog":

		sender := message.NewSender(b.client.API()).Peer(e, update)
		if err := b.handleLastLog(ctx, sender); err != nil {
			return err
		}

	case strings.HasPrefix(data, "download:"):
		sender := message.NewSender(b.client.API()).Peer(e, update)
		bookid := strings.TrimPrefix(data, "download:")
		id, _ := strconv.Atoi(bookid)
		filePath, err := b.bookService.GetFileBookWithID(ctx, id)
		if err != nil {
			b.logger.Println("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–∞:", err)
			sender.Text(ctx, "–ò–∑–≤–∏–Ω–∏—Ç–µ, —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω.")
			return err
		}

		// 4. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª –≤ Telegram
		// uploader.NewUploader —Ä–∞–∑–±–∏–≤–∞–µ—Ç —Ñ–∞–π–ª –Ω–∞ —á–∞—Å—Ç–∏ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö
		u := uploader.NewUploader(b.client.API())

		b.logger.Println("–ù–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞:", filePath)
		inputFile, err := u.FromPath(ctx, filePath)
		if err != nil {
			b.logger.Println("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (upload):", err)
			sender.Text(ctx, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.")
			return err
		}

		// 5. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º InputMediaUploadedDocument [web:7][web:10]
		// –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–π –º–æ–º–µ–Ω—Ç: –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ –º–µ–¥–∏–∞-–æ–±—ä–µ–∫—Ç
		// –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∏–º—è —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ Attributes, –∏–Ω–∞—á–µ –æ–Ω –ø—Ä–∏–¥–µ—Ç –∫–∞–∫ "file" –±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è
		fileName := filepath.Base(filePath)

		media := &tg.InputMediaUploadedDocument{
			File:     inputFile,
			MimeType: "application/pdf", // –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —Ä–µ–∞–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "application/pdf")
			Attributes: []tg.DocumentAttributeClass{
				&tg.DocumentAttributeFilename{FileName: fileName}, // –ß—Ç–æ–±—ã —É —Ñ–∞–π–ª–∞ –±—ã–ª–æ –∏–º—è
			},
			ForceFile: true, // –§–æ—Ä—Å–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –∏–º–µ–Ω–Ω–æ –∫–∞–∫ —Ñ–∞–π–ª (–¥–æ–∫—É–º–µ–Ω—Ç)
		}

		// 6. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ Media(), –∞ –Ω–µ Document()
		// Document() –∂–¥–µ—Ç tg.InputDocument (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª), –∞ –º—ã —à–ª–µ–º tg.InputMedia (–Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç)
		if _, err := sender.Media(ctx, message.Media(media)); err != nil {
			b.logger.Println("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ–¥–∏–∞:", err)
			sender.Text(ctx, fmt.Sprintf("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª: %s", err))
			return err
		}
		err = b.bookService.AddDownloadCountWithID(ctx, id)
		if err != nil {
			b.logger.Println("–û—à–∏–±–∫–∞ –ø—Ä–∏–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª-–≤–æ —Å–∫–∞—á–∏–≤–∞–Ω–∏–π ERR= ", err)
		}

		b.logger.Println("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!")

	default:
		b.logger.Printf("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–Ω–æ–ø–∫–∞: %s", string(data))
	}
	return b.answerCallback(ctx, update.QueryID, "–ö–Ω–æ–ø–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞!")
}

func (b *Bot) answerCallback(ctx context.Context, queryID int64, text string) error {
	_, err := b.client.API().MessagesSetBotCallbackAnswer(ctx, &tg.MessagesSetBotCallbackAnswerRequest{
		QueryID:   queryID,
		Message:   text,
		Alert:     false,
		CacheTime: 0,
	})
	return err
}

func (b *Bot) handleButtonAllLog(ctx context.Context, sender *message.RequestBuilder) error {
	b.SendFile(ctx, gl.LogPath, sender)
	return nil
}

func (b *Bot) handleLastLog(ctx context.Context, sender *message.RequestBuilder) error {
	// –¢–≤–æ—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "yes"
	b.SendLastLog(ctx, gl.LogPath, sender)
	return nil
}


//-docker-compose.yml-
services:
  db:
    image: postgres:15-alpine
    restart: always
    env_file:
      - .env
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U devuser -d postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  bot:
    build: .
    restart: always
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
    volumes:
      # --- –ò–°–ü–û–õ–¨–ó–£–ï–ú –ò–ú–ï–ù–û–í–ê–ù–ù–´–ï –¢–û–ú–ê ---
      # Docker —Å–∞–º —Å–æ–∑–¥–∞—Å—Ç —ç—Ç–∏ "–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –¥–∏—Å–∫–∏" –∏ –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –∏—Ö –≥–¥–µ-—Ç–æ —É —Å–µ–±—è –≤–Ω—É—Ç—Ä–∏.
      # –î–∞–Ω–Ω—ã–µ –Ω–µ –ø—Ä–æ–ø–∞–¥—É—Ç –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
      - bot_books:/app/books
      - bot_img:/app/img
      - bot_logs:/app/log
      - bot_config:/app/configs

# --- –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –û–ë–™–Ø–í–õ–Ø–ï–ú –ò–• –í–ù–ò–ó–£ ---
volumes:
  pg_data:      # –¢–≤–æ—è –±–∞–∑–∞
  bot_books:    # –•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–Ω–∏–≥
  bot_img:      # –•—Ä–∞–Ω–∏–ª–∏—â–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫
  bot_logs:     # –•—Ä–∞–Ω–∏–ª–∏—â–µ –ª–æ–≥–æ–≤
  bot_config:   # –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Ç–≥


//-cmd/bot/main.go-
package main

import (
	"context"
	"flag"
	"fmt"
	"os"
	"os/signal"
	"path/filepath"
	"strconv"
	"syscall"

	"HIGH_PR/gl"
	"HIGH_PR/internal/bot"
	"HIGH_PR/internal/logger"
	"HIGH_PR/internal/middleware"
	"HIGH_PR/internal/repository/postgres"
	booktags "HIGH_PR/internal/repository/postgres/bookTags"
	"HIGH_PR/internal/services"

	"github.com/gotd/td/session"
	"github.com/gotd/td/telegram"
	"github.com/gotd/td/tg"
)

func init() {
	createFolders()
	readEnv()
}

func createFolders() {
	dirsToCreate := []string{
		gl.DefaultSaveBook,
		gl.DefaultSaveImage,
	}

	// –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–ø–∫—É –ª–æ–≥–æ–≤ (–µ—Å–ª–∏ –ø—É—Ç—å –∑–∞–¥–∞–Ω)
	if gl.LogPath != "" {
		// filepath.Dir –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Ä–µ–∂–µ—Ç "app.log" –∏ –æ—Å—Ç–∞–≤–∏—Ç "log"
		// –ù–µ –∑–∞–±—É–¥—å import "path/filepath"
		dirsToCreate = append(dirsToCreate, filepath.Dir(gl.LogPath))
	}

	// –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–ø–∫—É —Å–µ—Å—Å–∏–∏
	if gl.SessionPath != "" {
		dirsToCreate = append(dirsToCreate, filepath.Dir(gl.SessionPath))
	}

	for _, dir := range dirsToCreate {
		// filepath.Clean —É–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–µ —Å–ª—ç—à–∏ –∏ —Ç–æ—á–∫–∏
		cleanDir := filepath.Clean(dir)

		// Skip, –µ—Å–ª–∏ –ø—É—Ç—å –ø—É—Å—Ç–æ–π –∏–ª–∏ "." (—Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞)
		if cleanDir == "." || cleanDir == "" {
			continue
		}

		// 0755 - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–∞–≤–∞ (rwxr-xr-x)
		err := os.MkdirAll(cleanDir, 0o755)
		if err != nil {
			fmt.Printf("‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ –º–æ–≥—É —Å–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É '%s': %v\n", cleanDir, err)
			// –¢—É—Ç –ª—É—á—à–µ —É–ø–∞—Å—Ç—å, —Ç–∞–∫ –∫–∞–∫ –±–µ–∑ –ø–∞–ø–æ–∫ –±–æ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ —Å–º–æ–∂–µ—Ç
			os.Exit(1)
		}
		fmt.Printf("‚úÖ –ü–∞–ø–∫–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞/—Å–æ–∑–¥–∞–Ω–∞: %s\n", cleanDir)
	}
}

func readEnv() {
	// 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–ª–∞–≥ -dev
	devMode := flag.Bool("dev", false, "–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–ª–æ–≥ –≤ –∫–æ–Ω—Å–æ–ª–∏)")
	flag.Parse()

	// 2. –°–†–ê–ó–£ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –Ω–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –ª–æ–≥–≥–µ—Ä
	logger.SetupLogger(*devMode)

	// 3. –ê –¢–ï–ü–ï–†–¨ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–õ–¨–ö–û –µ–≥–æ –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
	if *devMode {
		logger.Logger.Println("–†–µ–∂–∏–º —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.")
	} else {
		// –≠—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –ø–æ–π–¥–µ—Ç –≤ —Ñ–∞–π–ª, –∫–∞–∫ –∏ –æ–∂–∏–¥–∞–ª–æ—Å—å
		logger.Logger.Println("–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã.")
	}
}

func main() {
	logger.Logger.Println("üö¶ –ó–∞–ø—É—Å–∫")
	defer logger.Close()
	// 2. –°–æ–∑–¥–∞—ë–º –¥–∏—Å–ø–µ—Ç—á–µ—Ä –ó–ê–†–ê–ù–ï–ï
	dispatcher := tg.NewUpdateDispatcher()
	// ATTENTION
	appID, _ := strconv.Atoi(gl.AppID)

	// 3. –°–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç, –ø–µ—Ä–µ–¥–∞–≤–∞—è –µ–º—É –¥–∏—Å–ø–µ—Ç—á–µ—Ä —á–µ—Ä–µ–∑ Options
	client := telegram.NewClient(appID, gl.AppHash, telegram.Options{
		UpdateHandler: dispatcher,
		// ‚≠ê –î–û–ë–ê–í–õ–Ø–ï–ú MIDDLEWARE –ó–î–ï–°–¨
		Middlewares: []telegram.Middleware{
			middleware.LoggingMiddleware(logger.Logger),
			// –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ middleware
		},
		SessionStorage: &session.FileStorage{
			Path: gl.SessionPath,
		},
	})
	pool, err := postgres.Setup(gl.PostgreURL)
	if err != nil {
		logger.Logger.Println("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª –∫ DB: ", err)
		os.Exit(5432)
	}

	bookRep := booktags.NewBookRepository(pool)
	bookService := services.NewBookService(bookRep)

	botApp := bot.New(client, logger.Logger, dispatcher, bookService)
	ctx, cancel := signal.NotifyContext(context.Background(), os.Interrupt, syscall.SIGTERM)
	defer cancel()

	if err := botApp.Start(ctx); err != nil {
		logger.Logger.Fatalf("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: %v", err)
	}

	logger.Logger.Println("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.")
}


//-go.mod-
module HIGH_PR

go 1.25.3

require (
	github.com/dustin/go-humanize v1.0.1
	github.com/gotd/td v0.132.0
	github.com/jackc/pgx/v5 v5.7.6
)

require (
	github.com/cenkalti/backoff/v4 v4.3.0 // indirect
	github.com/coder/websocket v1.8.14 // indirect
	github.com/dlclark/regexp2 v1.11.5 // indirect
	github.com/fatih/color v1.18.0 // indirect
	github.com/ghodss/yaml v1.0.0 // indirect
	github.com/go-faster/errors v0.7.1 // indirect
	github.com/go-faster/jx v1.1.0 // indirect
	github.com/go-faster/xor v1.0.0 // indirect
	github.com/go-faster/yaml v0.4.6 // indirect
	github.com/google/uuid v1.6.0 // indirect
	github.com/gotd/ige v0.2.2 // indirect
	github.com/gotd/neo v0.1.5 // indirect
	github.com/jackc/pgpassfile v1.0.0 // indirect
	github.com/jackc/pgservicefile v0.0.0-20240606120523-5a60cdf6a761 // indirect
	github.com/jackc/puddle/v2 v2.2.2 // indirect
	github.com/klauspost/compress v1.18.0 // indirect
	github.com/mattn/go-colorable v0.1.14 // indirect
	github.com/mattn/go-isatty v0.0.20 // indirect
	github.com/ogen-go/ogen v1.15.2 // indirect
	github.com/segmentio/asm v1.2.0 // indirect
	go.opentelemetry.io/otel v1.38.0 // indirect
	go.opentelemetry.io/otel/metric v1.38.0 // indirect
	go.opentelemetry.io/otel/trace v1.38.0 // indirect
	go.uber.org/atomic v1.11.0 // indirect
	go.uber.org/multierr v1.11.0 // indirect
	go.uber.org/zap v1.27.0 // indirect
	golang.org/x/crypto v0.43.0 // indirect
	golang.org/x/exp v0.0.0-20230725093048-515e97ebf090 // indirect
	golang.org/x/mod v0.29.0 // indirect
	golang.org/x/net v0.46.0 // indirect
	golang.org/x/sync v0.17.0 // indirect
	golang.org/x/sys v0.37.0 // indirect
	golang.org/x/text v0.30.0 // indirect
	golang.org/x/tools v0.38.0 // indirect
	gopkg.in/yaml.v2 v2.4.0 // indirect
	rsc.io/qr v0.2.0 // indirect
)


